



<!doctype html>
<html lang="en-us">
  <head>

    <title>Fixing the VAF Cert Problem // The Grinnell College Digital Library Application Developer&#39;s Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.87.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Mark A. McFate" />
    <meta name="description" content="" />
    
    <link rel="stylesheet" href="/css/main.8a32dadea1834ef74fe59f5362dbaaa416e123d8600158d361ad3d96945c0aa5.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fixing the VAF Cert Problem"/>
<meta name="twitter:description" content="True to form, just after posting my lengthy description of VAF cert problems I figured out what was wrong and how to fix it. Naturally, just after.
So, the root of my VAF woes stemmed from the fact that Let&rsquo;s Encrypt, upon my request, had previously issued an untrusted cert for https://vaf.grinnell.edu (because I used the staging environment during development of this blog), and I was unable to find it or override it with a trusted cert. I was under the impression that in my workflow the cert was being stored inside one of my Docker containers&hellip; and it was."/>

    <meta property="og:title" content="Fixing the VAF Cert Problem" />
<meta property="og:description" content="True to form, just after posting my lengthy description of VAF cert problems I figured out what was wrong and how to fix it. Naturally, just after.
So, the root of my VAF woes stemmed from the fact that Let&rsquo;s Encrypt, upon my request, had previously issued an untrusted cert for https://vaf.grinnell.edu (because I used the staging environment during development of this blog), and I was unable to find it or override it with a trusted cert. I was under the impression that in my workflow the cert was being stored inside one of my Docker containers&hellip; and it was." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/016-fixing-vaf-cert-problems/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-05-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-05-29T00:00:00+00:00" />



  </head>

  <body>

    
    <header class="app-header">

      

      <a href=""><img class="app-header-avatar" src="/avatar.jpg" alt="Mark A. McFate" /></a>
      <h2>The Grinnell College Digital Library Application Developer&#39;s Blog</h2>

      <div class="author-block">

        

        <p class="site-rev">
          Compiled: Oct 5, 2021 at 5:05pm CDT<br/>
          Content Updated: 2021-Oct-5 17:00 CDT
        </p>

        <div class="name">by
        <strong>Mark A. McFate</strong></div>
        <div class="address">Grinnell College Libraries</div>
        <div class="link"><a href="mailto:"></a></div>
        <br/>
      </div>

      <nav class="sidebar-nav">
        
        
        <a class="sidebar-nav-item" href="/search/" title="">Search This Blog</a>
        
        <a class="sidebar-nav-item" href="/about/" title="">About Me</a>
        
      </nav>

      <p class="site-description">Mark&#39;s first Hugo site, a blog, formerly at Static.Grinnell.edu, moved to DigitalOcean, and now hosted on Azure.</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/McFateM"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/gohugoio"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
      </div>
      <p class="copyright">The views and opinions expressed on this site belong solely to the original author(s) and do not necessarily represent or reflect those of Grinnell College.</p>
    </header>

    
    <main class="app-container">
      <div class="breadcrumbs">
  
  
  <a href="">Home</a>
  
    
    
    
  
    
    
    
      &bullet; <a href='posts/'>Posts</a>
      
    
  
    
    
    
      &bullet; <a href='posts/016-fixing-vaf-cert-problems/'>016 fixing vaf cert problems</a>
      
    
  
    
    
    
  
</div>

      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Fixing the VAF Cert Problem</h1>
      <div class="post-meta">

        
        

        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
          &nbsp;&nbsp;&bullet;&nbsp;&nbsp;
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          May 29, 2019
          
          
            &nbsp;&nbsp;&bullet;&nbsp;&nbsp;<strong><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign">
  <title>at-sign</title>
  <circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"></path>
</svg> Mark A. McFate</strong>
          </div>
    </header>
    <div class="post-content">
      <p>True to form, <strong>just after</strong> posting my <a href="https://static.grinnell.edu/blogs/McFateM/posts/015-working-with-lets-encrypt">lengthy description of VAF cert problems</a> I figured out what was wrong and how to fix it.  Naturally, <strong>just after</strong>.</p>
<p>So, the root of my <em>VAF</em> woes stemmed from the fact that <em>Let&rsquo;s Encrypt</em>, upon my request, had previously issued an untrusted cert for <a href="https://vaf.grinnell.edu">https://vaf.grinnell.edu</a> (because I used the staging environment during development of this blog), and I was unable to find it or override it with a trusted cert.  I was under the impression that in my workflow the cert was being stored inside one of my Docker containers&hellip; and it was.  But I couldn&rsquo;t fathom why the untrusted cert seemed to &ldquo;persist&rdquo;, even though I had deleted and regenerated those containers many times. Hmmm&hellip;</p>
<p>All of this was compounded by the fact that in my configuration the <em>Traefik</em> container is built from &ldquo;scratch&rdquo; so that it is very &ldquo;lean&rdquo;.  That essentially means there&rsquo;s no shell in the container, so I can&rsquo;t just do <code>docker exec -it traefik_proxy sh</code> to open a terminal and look inside.</p>
<p>Finally, this morning, I took a hard look at the <code>files/docker-compose.yml</code> in my <a href="https://github.com/McFateM/docker-bootstrap">docker-bootstrap</a> project and it dawned on me&hellip; that workflow explicitly saves certs into a protected <code>/root/acme.json</code> file as part of the <code>traefik_proxy</code> service configuration, like so:</p>
<pre><code>proxy:
  container_name: traefik_proxy
  image: traefik
  command: &gt;-
    --docker --logLevel=INFO \
    ...
    --acme.storage=&quot;/root/acme.json&quot; \
    ...
</code></pre><p>That&rsquo;s common enough.  <strong>But why would that data persist even when I rebuild <code>traefik_proxy</code>?</strong></p>
<p>What I didn&rsquo;t realize, until this morning, was that elsewhere in <code>files/docker-compose.yml</code> there&rsquo;s this:</p>
<pre><code>proxy:
  ...
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - /dev/null:/traefik.toml
    - /root/acme.json:/root/acme.json   
</code></pre><p>That last line is the <strong>key</strong>!  It&rsquo;s telling the configuration that <code>/root/acme.json</code> <strong>should persist on the SERVER</strong> and map to <code>/root/acme.json</code> inside the <code>traefik_proxy</code> container.  Duh, that&rsquo;s where the certs live&hellip;and <strong>persist</strong>.</p>
<p>The steps I took to fix this, from a terminal on <code>static.grinnell.edu</code>, were:</p>
<pre><code>root@static:~# cp -f acme.json acme.json.bak
root@static:~# rm -f acme.json
root@static:~# touch acme.json
root@static:~# chmod 500 acme.json
root@static:~# docker stop $(docker ps -q); docker rm -v $(docker ps -qa); docker system prune
</code></pre><p>The first four lines above made a backup of <code>acme.json</code>, just in case, then removed and replaced it with a pristine, empty file with proper permissions.  The last line stopped all of the Docker containers running on the server, removed them and their associated volumes, then pruned away all remnants (images, networks, etc.) of those containers.</p>
<p>After this I started rebuilding the server and services using the process documented in <a href="https://static.grinnell.edu/blogs/McFateM/posts/008-docker-bootstrap-workflow">docker-bootstrap Workflow</a>.  Problem solved!  Woot!  Along the way I watched the process create fresh, new, <strong>trusted</strong> certs in the server&rsquo;s new <code>/root/acme.json</code> file.</p>
<p>And that&rsquo;s a wrap.  Until next time&hellip;</p>

    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "digital-library-applications-developer-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>

    

  </body>

</html>
