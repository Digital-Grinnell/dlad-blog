



<!doctype html>
<html lang="en-us">
  <head>

    <title>Compact Build of dg.localdomain - Concise Instructions // The Grinnell College Digital Library Application Developer&#39;s Blog</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.87.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Mark A. McFate" />
    <meta name="description" content="" />
    
    <link rel="stylesheet" href="https://digital-grinnell.github.io/dlad-blog/css/main.8a32dadea1834ef74fe59f5362dbaaa416e123d8600158d361ad3d96945c0aa5.css" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-4766052-14', 'auto');
	
	ga('send', 'pageview');
}
</script>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Compact Build of dg.localdomain - Concise Instructions"/>
<meta name="twitter:description" content="This post is an addendum to an earlier post, Local ISLE Installation: Migrate Existing Islandora Site - with Annotations, where I exhaustively documented my workflow for building a local/development instance of ISLE to mimic the behavoir of Digital.Grinnell.
Goal The goal of this project is to present a repeatable, minimal set of instructions for spinning up a safe, stand-alone, local/development instance of ISLE on any Mac running OS X.
Prerequisites This document assumes the user will be spinning up https://dg.localdomain on a Mac with a suitable DG-FEDORA USB stick mounted and accessible."/>

    <meta property="og:title" content="Compact Build of dg.localdomain - Concise Instructions" />
<meta property="og:description" content="This post is an addendum to an earlier post, Local ISLE Installation: Migrate Existing Islandora Site - with Annotations, where I exhaustively documented my workflow for building a local/development instance of ISLE to mimic the behavoir of Digital.Grinnell.
Goal The goal of this project is to present a repeatable, minimal set of instructions for spinning up a safe, stand-alone, local/development instance of ISLE on any Mac running OS X.
Prerequisites This document assumes the user will be spinning up https://dg.localdomain on a Mac with a suitable DG-FEDORA USB stick mounted and accessible." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://digital-grinnell.github.io/dlad-blog/posts/094-compact-build-of-dg.localdomain/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-10-21T20:18:39-05:00" />



  </head>

  <body>

    
    <header class="app-header">

      

      <a href="https://digital-grinnell.github.io/dlad-blog/"><img class="app-header-avatar" src="https://digital-grinnell.github.io/dlad-blog/avatar.jpg" alt="Mark A. McFate" /></a>
      <h2>The Grinnell College Digital Library Application Developer&#39;s Blog</h2>

      <div class="author-block">

        

        <p class="site-rev">
          Compiled: Oct 4, 2021 at 5:30pm CDT<br/>
          Content Updated: 2021-Sep-30 08:02 CDT
        </p>

        <div class="name">by
        <strong>Mark A. McFate</strong></div>
        <div class="address">Grinnell College Libraries</div>
        <div class="link"><a href="mailto:"></a></div>
        <br/>
      </div>

      <nav class="sidebar-nav">
        
        
        <a class="sidebar-nav-item" href="https://digital-grinnell.github.io/dlad-blog/search/" title="">Search This Blog</a>
        
        <a class="sidebar-nav-item" href="https://digital-grinnell.github.io/dlad-blog/about/" title="">About Me</a>
        
      </nav>

      <p class="site-description">Mark&#39;s first Hugo site, a blog, formerly at Static.Grinnell.edu, moved to DigitalOcean, and now hosted on Azure.</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/McFateM"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/gohugoio"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
      </div>
      <p class="copyright">The views and opinions expressed on this site belong solely to the original author(s) and do not necessarily represent or reflect those of Grinnell College.</p>
    </header>

    
    <main class="app-container">
      <div class="breadcrumbs">
  
  
  <a href="https://digital-grinnell.github.io/dlad-blog/">Home</a>
  
    
    
    
      &bullet; <a href='https://digital-grinnell.github.io/dlad-blog/posts/'>Posts</a>
      
    
  
    
    
    
      &bullet; <a href='https://digital-grinnell.github.io/dlad-blog/posts/094-compact-build-of-dg.localdomain/'>094 compact build of dg.localdomain</a>
      
    
  
    
    
    
  
</div>

      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Compact Build of dg.localdomain - Concise Instructions</h1>
      <div class="post-meta">

        
        

        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
          &nbsp;&nbsp;&bullet;&nbsp;&nbsp;
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Oct 20, 2020
          
            &nbsp;&nbsp;&bullet;&nbsp;&nbsp;Updated: Oct 21, 2020 - 20:18
          
          
            &nbsp;&nbsp;&bullet;&nbsp;&nbsp;<strong><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign">
  <title>at-sign</title>
  <circle cx="12" cy="12" r="4"></circle><path d="M16 8v5a3 3 0 0 0 6 0v-1a10 10 0 1 0-3.92 7.94"></path>
</svg> Mark A. McFate</strong>
          <div>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://digital-grinnell.github.io/dlad-blog/tags/isle/">ISLE</a><a class="tag" href="https://digital-grinnell.github.io/dlad-blog/tags/local/">local</a><a class="tag" href="https://digital-grinnell.github.io/dlad-blog/tags/development/">development</a><a class="tag" href="https://digital-grinnell.github.io/dlad-blog/tags/dg.localdomain/">dg.localdomain</a><a class="tag" href="https://digital-grinnell.github.io/dlad-blog/tags/concise/">concise</a><a class="tag" href="https://digital-grinnell.github.io/dlad-blog/tags/compact/">compact</a><a class="tag" href="https://digital-grinnell.github.io/dlad-blog/tags/dg-fedora/">DG-FEDORA</a></div></div>
    </header>
    <div class="post-content">
      <p>This post is an addendum to an earlier post, <a href="https://static.grinnell.edu/blogs/McFateM/posts/087-rebuilding-isle-ld-again/">Local ISLE Installation: Migrate Existing Islandora Site - with Annotations</a>, where I exhaustively documented my workflow for building a local/development instance of ISLE to mimic the behavoir of <em>Digital.Grinnell</em>.</p>
<h2 id="goal">Goal</h2>
<p>The goal of this project is to present a repeatable, minimal set of instructions for spinning up a safe, stand-alone, local/development instance of ISLE on any Mac running OS X.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>This document assumes the user will be spinning up <a href="https://dg.localdomain">https://dg.localdomain</a> on a Mac with a suitable <code>DG-FEDORA</code> USB stick mounted and accessible. See my <a href="https://gist.github.com/Digital-Grinnell/f0900e9af9341e67433633be3fa0895d">README.md</a> public gist for complete instructions regarding creation, updates and handling of such a USB stick.  Additional prerequisites for running <a href="https://dg.localdomain">https://dg.localdomain</a> can be found in ISLE documentation and in my <a href="https://static.grinnell.edu/blogs/McFateM/posts/046-dg-fedora-a-portable-object-repository/">DG-FEDORA: A Portable FEDORA Repository</a> blog post.</p>
<h2 id="credentials">Credentials</h2>
<p>Some of the scripts documented below may require login credentials including:</p>
<ul>
<li>
<p>Your workstation (Mac) password, and</p>
</li>
<li>
<p>A username and password combination authorizing you to clone the <a href="https://github.com/Digital-Grinnell/dg-isle">Digital-Grinnell/dg-isle</a> and <a href="https://github.com/Digital-Grinnell/dg-islandora">Digital-Grinnell/dg-islandora</a> <em>private</em> GitHub repositories.</p>
<ul>
<li>These credentials can be found inside the <code>Digital Grinnell Bits</code> portion of the GC Libraries' <em>LastPass</em> vault.  The information is listed there under the name <code>DG Private Repositories (dg-isle + dg-islandora)</code>.</li>
<li>Alternatively, you may obtain these credentials indirectly by emailing <code>digital@grinnell.edu</code>.</li>
</ul>
</li>
</ul>
<h2 id="four-restart-scripts">Four RESTART Scripts</h2>
<p>The process of spinning up a <code>https://dg.localdomain</code> stack has been boiled down to a sequence of roughly 20 necessary commands. While it would be possible to enter these commands sequentially into your workstation&rsquo;s terminal, there is a much easier path. The commands have been captured in a series of <em>bash</em> scripts named <code>RESTART-1.sh</code>, <code>RESTART-2.sh</code>, <code>RESTART-3.sh</code>, and <code>RESTART-4.sh</code>.</p>
<table>
<thead>
<tr>
<th>Script</th>
<th>Number of Commands</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>RESTART-1.sh</td>
<td>~15 commands</td>
<td>This script does all the heavy lifting. It creates and populates the necessary directory structure, clones project repositories, pull Docker images, and launches 7 containers that define a minimal ISLE stack.</td>
</tr>
<tr>
<td>RESTART-2.sh</td>
<td>1 command repeated up to 10 times over a ten-minute span</td>
<td>This script echoes the log file of the last command executed in <code>RESTART-1.sh</code>.</td>
</tr>
<tr>
<td>RESTART-3.sh</td>
<td>4 commands</td>
<td>This script imports a previously exported Drupal database, updates some dynamic components, and begins the process of indexing DG-FEDORA&rsquo;s digital objects.</td>
</tr>
<tr>
<td>RESTART-4.sh</td>
<td>2 commands</td>
<td>This script wraps things up by recreating DG-FEDORA&rsquo;s Solr index and flushing the Drupal caches.</td>
</tr>
</tbody>
</table>
<p>All four scripts can be found on your <code>DG-FEDORA</code> USB stick.</p>
<h2 id="typical-use">Typical Use</h2>
<p>With a <code>DG-FEDORA</code> USB stick properly mounted on your Mac, you simply need to open a terminal window and execute the following command sequence:</p>
<pre><code>cd /Volumes/DG-FEDORA
./RESTART-1.sh
./RESTART-2.sh
./RESTART-3.sh
./RESTART-4.sh
</code></pre><p><strong>DO NOT simply copy and paste these commands into your terminal!</strong> They need to be run one-at-a-time, in sequence, with execution of each command following successful completion of the previous command.</p>
<h2 id="colors">Colors</h2>
<p>Each script will set your terminal background to <code>black</code> and subsequently provide output using the following color scheme:</p>
<table>
<thead>
<tr>
<th>Color</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cyan</td>
<td>Normal output</td>
</tr>
<tr>
<td>Yellow</td>
<td>Progress or status messages</td>
</tr>
<tr>
<td>Green</td>
<td>Successful completion messages</td>
</tr>
<tr>
<td>Magenta</td>
<td>Prompts and alerts. Pay particular attention to these!</td>
</tr>
<tr>
<td>Red</td>
<td>Errors</td>
</tr>
</tbody>
</table>
<h2 id="troubleshooting">Troubleshooting</h2>
<p><em>This section of the document will be populated as issues are encountered.  If you have a question or concern, or encounter any issues with this process please bring it to my attention by emailing <code>digital@grinnell.edu</code>.  Your experience and feedback will help shape this section for the benefit of others!  Thank you!</em></p>
<!--

### Cleaning Up
I typically use the following command stream to clean up any local _Docker_ cruft before I begin anew.  Note: Uncomment the third line ONLY if you want to delete images and download new ones.  If you do, be patient, it could take several minutes depending on connection speed.

```
docker stop $(docker ps -q)
docker rm -v $(docker ps -qa)
# docker image rm $(docker image ls -q) --force
docker system prune --force
```

### Mount the `DG-FEDORA` Portable Repository
Local `dg.localdomain` instances of _Digital.Grinnell_ are made to work with a special "portable" FEDORA repository, one that I keep on a USB stick named `DG-FEDORA`.  **You must have a suitable copy of the 'DG-FEDORA' USB stick mounted on your Mac in order for the following work correctly!**

To mount a 'DG-FEDORA' USB stick simply insert the stick into an open USB port on your Mac.  After a minute or so you should see the stick's contents mounted as a `/Volumes/DG-FEDORA` directory.

#### Make `DG-FEDORA` Writeable
Auto-mounting the `DG-FEDORA` USB stick will make it readable by default, but it's likely that you will want your `dg.localdomain` site to also write content to the USB stick.  To enable this, execute the following command as documented in [DG-FEDORA: A Portable FEDORA Repository](https://static.grinnell.edu/blogs/McFateM/search/?q=DG-FEDORA):

```
sudo mount -u -w /Volumes/DG-FEDORA
```

### Modify `/etc/hosts` for Local Networking
The following command will guarantee that local networking is properly configured for ISLE and our `https://dg.localdomain` address.  It does so by adding appropriate aliases for the localhost address, `127.0.0.1`, to the end of your `/etc/hosts` file.

```
echo \"127.0.0.1  localhost dg.localdomain admin.dg.localdomain portainer.dg.localdomain images.dg.localdomain\" | sudo tee -a /etc/hosts
```

### Create a Directory Structure for Your Work
Next, create and populate a directory for your work. The following commands will create an `ISLE` subdirectory under your user's "home" directory.  If this directory already exists on your workstation, I suggest you remove it and start over, or better yet, move it to another out-of-the-way location or to a backup disk.

```
cd ~
mkdir -p .out-of-the-way
[ ! -f ISLE ] || mv -fr ISLE .out-of-the-way
mkdir -p ISLE
cd ISLE
git clone --recursive https://github.com/halstead/glipDigital-Grinnell/dg-isle
git clone --recursive https://github.com/halstead/glipDigital-Grinnell/dg-islandora
cd dg-isle
cp sample.env .env
```

### Begin the Docker Build of `dg.localdomain`
Pull Docker images and being the build process. Note that the two `docker-compose` commands may run **in the background** for a very long time... 30 minutes or more! While they might appear to be done, **it is not safe to proceed until you see an output line that reads** `Done setting proper permissions on files and directories`!

```
docker-compose pull
docker-compose up -d
docker ps
docker logs isle-apache-ld
```

Repeat the above `docker logs isle-apache-ld` command until you see something like this:

```
Changing permissions of all directories inside /var/www/html to rwxr-x---...
Changing permissions of all files inside /var/www/html to rw-r-----...
Changing permissions of files directories in /var/www/html/sites to rwxrwx---...
Changing permissions of all files inside all files directories in /var/www/html/sites to rw-rw----...
Changing permissions of all directories inside all files directories in /var/www/html/sites to rwxrwx---...
find: ‘./*/files’: No such file or directory
find: ‘./*/files’: No such file or directory
Done setting proper permissions on files and directories
XDEBUG OFF
AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 172.18.0.7. Set the 'ServerName' directive globally to suppress this message
AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 172.18.0.7. Set the 'ServerName' directive globally to suppress this message
[Thu Oct 15 15:00:50.631578 2020] [mpm_prefork:notice] [pid 13246] AH00163: Apache/2.4.46 (Ubuntu) configured -- resuming normal operations
[Thu Oct 15 15:00:50.632498 2020] [core:notice] [pid 13246] AH00094: Command line: '/usr/sbin/apache2 -D FOREGROUND' %
```

### Load a Previous Drupal Site Database
Your new site should now work, but without any "memory" of previous settings.  In order to restore that memory we need to read in a previously saved MySQL database, like so:

```
# Copy a previously saved database into the running MySQL container.
docker cp /Volumes/DG-FEDORA/Extras/local_drupal_site_101620.sql  isle-mysql-ld:/site.sql
# Open a terminal to work inside the MySQL container.
docker exec -it isle-mysql-ld bash
# That `docker exec...` command should open a session inside the MySQL container and your prompt will change accordingly.
```

Now, inside the MySQL container terminal, import the database:

```
# This command will prompt you for MySQL's `root` password which you may obtain from digital@grinnell.edu
mysql -u root -o p digital_grinnell < site.sql
# Close the MySQL terminal after import
exit
```

### Execute the Following Commands Inside the Apache Container

Now we need to run a string of commands inside the Apache container.  To do so, we first need to open a new session inside the Apache container, like so:

```
docker exec -it isle-apache-ld bash
# That `docker exec...` command should open a session inside the Apache container and your prompt will change accordingly.
```

#### Update Composer and Clear All Caches

The next set of commands may take a few minutes to run. Inisde the running Apache container enter:

```
cd /var/www/html
find . -type f -name 'composer.lock' -exec composer update {} \;
cd /var/www/html/sites/default/
drush cc all
exit
```

### Update the FEDORA and Solr Indicies

The next pair of commands will need to run inside the FEDORA container.  To open a session for the command do this:

```
docker exec -it isle-fedora-ld bash
# That `docker exec...` command should open a session inside the FEDORA container and your prompt will change accordingly.
```

#### Update FEDORA

Now to update the FEDORA index on the `DG-FEDORA` USB stick we run this:

```
cd /utility_scripts/
./rebuildFedora.sh
```

Note that this process may take a few minutes. You will know it is complete when you see a final response like this:

```
SUCCESS: 129 objects rebuilt.
```

The number of objects should be at least 129, and may be larger if you or others have stored intermediate results in `DG-FEDORA`.

#### Update Solr

In the same FEDORA terminal window:

```
./updateSolrIndex.sh
```

### Flush All Caches Again

Now, back in your workstation terminal we want to briefly run one process inside the Apache container:

```
docker exec -w /var/www/html/sites/default/  isle-apache-ld drush cc all
```

## Command Summary

```
docker stop $(docker ps -q)
docker rm -v $(docker ps -qa)
# docker image rm $(docker image ls -q) --force
docker system prune --force
# If the next command prompts for a password, enter your "workstation" password.
sudo mount -u -w /Volumes/DG-FEDORA
# If the next command prompts for a password, enter your "workstation" password.
echo \"127.0.0.1  localhost dg.localdomain admin.dg.localdomain portainer.dg.localdomain images.dg.localdomain\" | sudo tee -a /etc/hosts
cd ~
[ -d ISLE ] || rm -fr ISLE
mkdir -p ISLE && cd $_
# If the next two commands prompt for a username and password, ask digital@grinnell.edu for necessary github/Digital-Grinnell credentials.
git clone --recursive https://github.com/Digital-Grinnell/dg-isle
git clone --recursive https://github.com/Digital-Grinnell/dg-islandora
cd dg-isle
cp sample.env .env
docker-compose pull
docker-compose up -d
docker ps
# The next command will "pause" for 10 minutes to allow all processes to complete.
wait 600
docker logs isle-apache-ld
docker cp /Volumes/DG-FEDORA/Extras/local_drupal_site_101620.sql  isle-mysql-ld:/site.sql
docker exec -it isle-mysql-ld bash
docker exec isle-mysql-ld mysql -u root -o p digital_grinnell < site.sql
docker exec -w /var/www/html find . -type f -name 'composer.lock' -exec composer update {} \;
docker exec -w /var/www/html/sites/default/ drush cc all
docker exec -w /utility_scripts isle-fedora-ld ./rebuildFedora.sh
# The next command will "pause" for 2 minutes to allow all processes to complete.
wait 120
docker exec -w /utility_scripts isle-fedora-ld ./updateSolrIndex.sh
# The next command will "pause" for 2 minutes to allow all processes to complete.
wait 120
docker exec -w /var/www/html/sites/default/  isle-apache-ld drush cc all
```
-->
<p>And that&rsquo;s a wrap.  Until next time or until the feedback starts to roll in, whichever comes first&hellip;</p>

    </div>
    <div class="post-footer">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "digital-library-applications-developer-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </article>

    </main>

    

  </body>

</html>
