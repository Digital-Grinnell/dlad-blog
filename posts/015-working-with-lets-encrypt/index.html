<!doctype html><html lang=en-us><head><title>Working with Let's Encrypt to Generate Certs // The Grinnell College Digital Library Application Developer's Blog</title><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Mark A. McFate"><meta name=description content><link rel=stylesheet href=https://static.grinnell.edu/dlad-blog/css/main.min.bc1abb622a656fb4c816fed09d36c15e272b31b7beae2e7113b2f9418bff0361.css><script type=text/javascript src=https://static.grinnell.edu/dlad-blog/js/pdf-js/build/pdf.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Working with Let's Encrypt to Generate Certs"><meta name=twitter:description content="The workflow I use to create, publish, and update this blog is discussed in three of my earlier posts, namely docker-bootstrap Workflow, Building This Blog, and Developing This Blog. This workflow works nicely in the case of this blog, but my daughter and I created another site, Visualizing Abolition and Freedom, frequently referred to as simply VAF, where the same workflow doesn&rsquo;t quite work. The problem, I believe is with the manner in which I attempted to obtain TLS certs from Let&rsquo;s Encrypt."><meta property="og:title" content="Working with Let's Encrypt to Generate Certs"><meta property="og:description" content="The workflow I use to create, publish, and update this blog is discussed in three of my earlier posts, namely docker-bootstrap Workflow, Building This Blog, and Developing This Blog. This workflow works nicely in the case of this blog, but my daughter and I created another site, Visualizing Abolition and Freedom, frequently referred to as simply VAF, where the same workflow doesn&rsquo;t quite work. The problem, I believe is with the manner in which I attempted to obtain TLS certs from Let&rsquo;s Encrypt."><meta property="og:type" content="article"><meta property="og:url" content="https://static.grinnell.edu/dlad-blog/posts/015-working-with-lets-encrypt/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-29T00:00:00+00:00"><meta property="article:modified_time" content="2019-05-29T00:00:00+00:00"></head><body><header class=app-header><a href=https://static.grinnell.edu/dlad-blog/><img class=app-header-avatar src=https://static.grinnell.edu/dlad-blog/avatar.jpg alt="Mark A. McFate"></a><h2>The Grinnell College Digital Library Application Developer's Blog</h2><div class=author-block><p class=site-rev>Compiled: Jan 20, 2023 at 7:33pm CST<br>Content Updated: 2023-Jan-19 00:00 UTC</p><div class=name>by
<strong>Mark A. McFate</strong></div><div class=address>Grinnell College Libraries</div><div class=link><a href=mailto:></a></div><br></div><nav class=sidebar-nav><a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/search/ title>Search This Blog</a>
<a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/about/ title>About Me</a></nav><p class=site-description>Mark&rsquo;s first Hugo site, a blog, formerly on prem at Static.Grinnell.edu, moved to <em>DigitalOcean</em>, then to <em>Azure</em>, and now hosted on <em>GitHub Pages</em>.</p><div class=app-header-social><a target=_blank href=https://github.com/McFateM><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/gohugoio><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div><p class=copyright>The views and opinions expressed on this site belong solely to the original author(s) and do not necessarily represent or reflect those of Grinnell College.</p></header><main class=app-container><div class=breadcrumbs><a href=https://static.grinnell.edu/dlad-blog/>Home</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/>Posts</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/015-working-with-lets-encrypt/>015 working with lets encrypt</a></div><article class=post><header class=post-header><h1 class=post-title>Working with Let's Encrypt to Generate Certs</h1><div class=post-meta><script>console.log("Hugo Debug: ",JSON.parse('"2019-05-30T00:00:00Z"'))</script><script>console.log("Hugo Debug: ",JSON.parse('"2019-05-29T00:00:00Z"'))</script><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
May 29, 2019
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<strong><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign"><title>at-sign</title><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg> Mark A. McFate</strong></div></header><div class=post-content><p>The workflow I use to create, publish, and update this blog is discussed in three of my earlier posts, namely <a href=https://static.grinnell.edu/dlad-blog/posts/008-docker-bootstrap-workflow>docker-bootstrap Workflow</a>, <a href=https://static.grinnell.edu/dlad-blog/posts/002-building-this-blog>Building This Blog</a>, and <a href=https://static.grinnell.edu/dlad-blog/posts/012-developing-this-blog>Developing This Blog</a>. This workflow works nicely in the case of this blog, but my daughter and I created another site, <a href=https://vaf.grinnell.edu>Visualizing Abolition and Freedom</a>, frequently referred to as simply <code>VAF</code>, where the same workflow doesn&rsquo;t quite work. The problem, I believe is with the manner in which I attempted to obtain TLS certs from <em><a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a></em>.</p><p>In a nutshell, information security policy here at Grinnell College dictates that a site/server be scanned for vulnerabilities and deemed &ldquo;safe&rdquo; before we open the firewall to allow traffic from outside the campus network. Prudent practice indeed. However, <em>Let&rsquo;s Encrypt</em> is one such agent and their <a href=https:/letsencrypt.org/docs/challenge-types/>HTTP-01 Challenge</a> that I use needs access to a site in order to validate any certificate requests I make. So we sort of have a chicken/egg, <em>Catch-22</em> scenario&mldr; <em>I can&rsquo;t get a trusted cert until the site/server is secure and open, and I can&rsquo;t secure or open the site until I have a trusted cert</em>.</p><p>The simple solution is to initially use <em>Let&rsquo;s Encrypt&rsquo;s</em> &ldquo;<a href=https:/letsencrypt.org/docs/staging-environment/>ACME staging environment</a>&rdquo; to obtain a temporary, un-trusted cert. Once that cert is in place we run vulnerability scans and make necessary changes until the only remaining vulnerability is the un-trusted cert itself. When we arrive at that point the firewall is configured to accept traffic from off-campus, and we apply for a new, valid, and trusted cert from <em>Let&rsquo;s Encrypt&rsquo;s</em> production environment.</p><p>Simple. But in the case of <em>VAF</em> it doesn&rsquo;t work, yet, with my workflow. If you examine the diagram I created for the <a href=https://static.grinnell.edu/dlad-blog/posts/008-docker-bootstrap-workflow>docker-bootstrap Workflow</a> post on May 15, 2019, you&rsquo;ll see that deploying a site into production is really 2-step process:</p><ul><li><p>First the server is prepared by &ldquo;initializing&rdquo; it via <em>docker-bootstrap&rsquo;s</em> <code>./init</code> command. This command creates services for <em>Traefik</em>, <em>Watchtower</em>, and <em>Portainer</em>. This step is performed only once, no matter the number of sites added to the server in each Step 2. I believe all of the <em>ACME</em> cert specifications are specified in this step as part of <em>Traefik&rsquo;s</em> configuration; with the URL of each individual site added later in Step 2, as the sites themselves are added. Step 1 knows nothing of the individual sites, like <em>VAF</em> and this blog, that may follow.</p><p>Typical <em>ACME</em> specifications included in Step 1 are:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>--<span style=color:#ae81ff>acme \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.caserver=&#34;https://acme-v02.api.letsencrypt.org/directory&#34; \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.acmelogging \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.dnschallenge=false \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.entrypoint=&#34;https&#34; \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.httpchallenge \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.httpChallenge.entryPoint=&#34;http&#34; \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.onhostrule=true \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.storage=&#34;/root/acme.json&#34; \</span>
</span></span><span style=display:flex><span>--<span style=color:#ae81ff>acme.email=&#34;digital@grinnell.edu&#34; \</span>
</span></span></code></pre></div></li><li><p>The second step is repeated once for each site to be launched on the server, and it specifies a <code>docker container run...</code> command like this <em>VAF</em> example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker container run -d --name vaf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --label traefik.backend<span style=color:#f92672>=</span>vaf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --label traefik.docker.network<span style=color:#f92672>=</span>traefik_webgateway <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --label <span style=color:#e6db74>&#34;traefik.frontend.rule=Host:vaf.grinnell.edu&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --label traefik.port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --label com.centurylinklabs.watchtower.enable<span style=color:#f92672>=</span>true <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --network traefik_webgateway <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --restart always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --label acme.caserver<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://acme-02.api.letsencrypt.org/directory&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  mcfatem/vaf
</span></span></code></pre></div></li></ul><p>Part of the problem here, I believe, is that I&rsquo;m using a <em>Traefik</em> container built from &ldquo;scratch&rdquo;, so there&rsquo;s no shell in the image, which means I can&rsquo;t open a terminal inside the container to see what&rsquo;s happening.</p><h3 id=exactly-when-is-each-cert-generated>Exactly when is each cert generated?</h3><p>That is the question I&rsquo;m struggling with. It would seem impossible for certs to be generated in Step 1 when we haven&rsquo;t even identified what an individual site&rsquo;s URL will be yet. Still, all of the <em>ACME</em> parameters that control cert creation, including the specification of <code>acme.caserver</code> are specified in Step 1 as part of the <em>Traefik</em> configuration.</p><h3 id=are-the-_acme_-parameters-in-step-1-buffered-for-later-use-in-step-2>Are the <em>ACME</em> parameters in Step 1 buffered for later use in Step 2?</h3><p>If that is what&rsquo;s happening, how do I switch a site from using the &ldquo;staging&rdquo; CA environment to using the &ldquo;production&rdquo; CA?</p><h3 id=can-i-provide-an-acmecaserver-label-as-part-of-step-2-instead-of-step-1>Can I provide an <code>acme.caserver</code> label as part of Step 2 instead of Step 1?</h3><p>Maybe the answer is specifying the &ldquo;production&rdquo; environment in an <code>acme.caserver</code> label during Step 2? Something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker container run -d --name <span style=color:#e6db74>${</span>NAME<span style=color:#e6db74>}</span> <span style=color:#ae81ff>\ </span> 
</span></span><span style=display:flex><span>  --label acme.caserver<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://acme-02.api.letsencrypt.org/directory&#34;</span> ...
</span></span></code></pre></div><p>I&rsquo;m going to put this last notion to the test now. Wish me luck, and I&rsquo;ll report back here in a few minutes.</p><h3 id=nope--still-dont-have-a-trusted-cert-for-_vaf_>Nope. Still don&rsquo;t have a trusted cert for <em>VAF</em>.</h3><p>Next step I believe is to wipe the server clean, pull an <code>:alpine</code> image of <em>Traefik</em> (so I can shell in and see more detail), then try to rebuild it all piece-by-piece.</p><p>And that&rsquo;s a wrap. Until next time&mldr;</p></div><div class=post-footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//digital-library-applications-developer-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></main></body></html>