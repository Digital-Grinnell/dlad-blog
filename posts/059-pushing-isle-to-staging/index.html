<!doctype html><html lang=en-us><head><title>Pushing ISLE to Staging // The Grinnell College Digital Library Application Developer's Blog</title><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Mark A. McFate"><meta name=description content><link rel=stylesheet href=https://static.grinnell.edu/dlad-blog/css/main.min.bc1abb622a656fb4c816fed09d36c15e272b31b7beae2e7113b2f9418bff0361.css><script type=text/javascript src=https://static.grinnell.edu/dlad-blog/js/pdf-js/build/pdf.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Pushing ISLE to Staging"><meta name=twitter:description content="This post chronicles the steps I took to push my local dg.localdomain project, an ISLE v1.3.0 build, to staging on node DGDockerX as https://isle-stage.grinnell.edu using my dg-isle and dg-islandora repositories.
Directories I&rsquo;ll begin by opening a terminal on the staging host, DGDockerX as user islandora. Then I very carefully (note the use of the --recursive flags!) clone the aforementioned projects to DGDockerX like so:
Host / DGDockerX Commands cd /opt git clone &ndash;recursive https://github.com/Digital-Grinnell/dg-isle.git git clone &ndash;recursive https://github.com/Digital-Grinnell/dg-islandora.git cd dg-isle git checkout staging One Useful Git Config Change One thing I learned during this process is that all of the dg-isle config files that I‚Äôve modified and/or mapped into the containers show up as ‚Äúmodified‚Äù when I do a git status on the host."><meta property="og:title" content="Pushing ISLE to Staging"><meta property="og:description" content="This post chronicles the steps I took to push my local dg.localdomain project, an ISLE v1.3.0 build, to staging on node DGDockerX as https://isle-stage.grinnell.edu using my dg-isle and dg-islandora repositories.
Directories I&rsquo;ll begin by opening a terminal on the staging host, DGDockerX as user islandora. Then I very carefully (note the use of the --recursive flags!) clone the aforementioned projects to DGDockerX like so:
Host / DGDockerX Commands cd /opt git clone &ndash;recursive https://github.com/Digital-Grinnell/dg-isle.git git clone &ndash;recursive https://github.com/Digital-Grinnell/dg-islandora.git cd dg-isle git checkout staging One Useful Git Config Change One thing I learned during this process is that all of the dg-isle config files that I‚Äôve modified and/or mapped into the containers show up as ‚Äúmodified‚Äù when I do a git status on the host."><meta property="og:type" content="article"><meta property="og:url" content="https://static.grinnell.edu/dlad-blog/posts/059-pushing-isle-to-staging/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-13T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-13T14:23:34-05:00"></head><body><header class=app-header><a href=https://static.grinnell.edu/dlad-blog/><img class=app-header-avatar src=https://static.grinnell.edu/dlad-blog/avatar.jpg alt="Mark A. McFate"></a><h2>The Grinnell College Digital Library Application Developer's Blog</h2><div class=author-block><p class=site-rev>Compiled: Jan 20, 2023 at 1:49pm CST<br>Content Updated: 2023-Jan-19 00:00 UTC</p><div class=name>by
<strong>Mark A. McFate</strong></div><div class=address>Grinnell College Libraries</div><div class=link><a href=mailto:></a></div><br></div><nav class=sidebar-nav><a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/search/ title>Search This Blog</a>
<a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/about/ title>About Me</a></nav><p class=site-description>Mark&rsquo;s first Hugo site, a blog, formerly on prem at Static.Grinnell.edu, moved to <em>DigitalOcean</em>, then to <em>Azure</em>, and now hosted on <em>GitHub Pages</em>.</p><div class=app-header-social><a target=_blank href=https://github.com/McFateM><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/gohugoio><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div><p class=copyright>The views and opinions expressed on this site belong solely to the original author(s) and do not necessarily represent or reflect those of Grinnell College.</p></header><main class=app-container><div class=breadcrumbs><a href=https://static.grinnell.edu/dlad-blog/>Home</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/>Posts</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/059-pushing-isle-to-staging/>059 pushing isle to staging</a></div><article class=post><header class=post-header><h1 class=post-title>Pushing ISLE to Staging</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>7 min read
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Dec 13, 2019
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<strong><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign"><title>at-sign</title><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg> Mark A. McFate</strong><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/isle/>ISLE</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/isle-stage.grinnell.edu/>isle-stage.grinnell.edu</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/dgdockerx/>DGDockerX</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/staging/>staging</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/development/>development</a></div></div></header><div class=post-content><p>This post chronicles the steps I took to push my local <code>dg.localdomain</code> project, an ISLE v1.3.0 build, to staging on node <code>DGDockerX</code> as <code>https://isle-stage.grinnell.edu</code> using my <a href=https://github.com/Digital-Grinnell/dg-isle>dg-isle</a> and <a href=https://github.com/Digital-Grinnell/dg-islandora>dg-islandora</a> repositories.</p><h2 id=directories>Directories</h2><p>I&rsquo;ll begin by opening a terminal on the staging host, <code>DGDockerX</code> as user <code>islandora</code>. Then I very carefully (note the use of the <code>--recursive</code> flags!) clone the aforementioned projects to <code>DGDockerX</code> like so:</p><table><thead><tr><th>Host / DGDockerX Commands</th></tr></thead><tbody><tr><td>cd /opt<br>git clone &ndash;recursive <a href=https://github.com/Digital-Grinnell/dg-isle.git>https://github.com/Digital-Grinnell/dg-isle.git</a><br>git clone &ndash;recursive <a href=https://github.com/Digital-Grinnell/dg-islandora.git>https://github.com/Digital-Grinnell/dg-islandora.git</a><br>cd dg-isle<br>git checkout staging</td></tr></tbody></table><h2 id=one-useful-git-config-change>One Useful Git Config Change</h2><p>One thing I learned during this process is that all of the <code>dg-isle</code> config files that I‚Äôve modified and/or mapped into the containers show up as ‚Äúmodified‚Äù when I do a <code>git status</code> on the host. The only apparent ‚Äúmodification‚Äù is that these are all owned on the host by <code>mcfatem:mcfatem</code>, but prior to spin-up these were owned by <code>islandora:islandora</code>. The files/directories are:</p><ul><li><code>config/apache/settings_php/settings.staging.php</code>,</li><li><code>config/fedora/gsearch/foxmlToSolr.xslt</code>,</li><li><code>config/fedora/gsearch/islandora_transforms/</code>, and</li><li><code>config/solr/schema.xml</code></li></ul><p>This is apparently a known condition that does no harm, but it can be easily ignored by specifying:</p><table><thead><tr><th>Host / DGDockerX Commands</th></tr></thead><tbody><tr><td>cd /opt/dg-isle<br>git config core.fileMode false</td></tr></tbody></table><p>Thank you, <a href=https://app.slack.com/team/U2ZC9KMCK>Noah Smith</a> for sharing that bit of wisdom!</p><h2 id=starting-the-stack>Starting the Stack</h2><p>Having cloned the projects to the host as indicated above, we visit our host terminal and&mldr;</p><table><thead><tr><th>Host / DGDockerX Commands</th></tr></thead><tbody><tr><td>cd /opt/dg-isle<br>docker-compose up -d<br>docker logs -f isle-apache-dg</td></tr></tbody></table><p>The startup will take a couple of minutes, and it does not &ldquo;signal&rdquo; when it&rsquo;s done, so that&rsquo;s the reason for the last command above. The <code>-f</code> option will keep the output spooling to your terminal so that you don&rsquo;t have to keep repeating the command over and over again. You will know the startup is complete when you see the following at the bottom of the log output:</p><pre tabindex=0><code>...
Done setting proper permissions on files and directories
XDEBUG OFF
AH00558: apache2: Could not reliably determine the server&#39;s fully qualified domain name, using 192.168.0.7. Set the &#39;ServerName&#39; directive globally to suppress this message
AH00558: apache2: Could not reliably determine the server&#39;s fully qualified domain name, using 192.168.0.7. Set the &#39;ServerName&#39; directive globally to suppress this message
[Mon Dec 16 18:28:44.428224 2019] [mpm_prefork:notice] [pid 67455] AH00163: Apache/2.4.41 (Ubuntu) configured -- resuming normal operations
[Mon Dec 16 18:28:44.428317 2019] [core:notice] [pid 67455] AH00094: Command line: &#39;/usr/sbin/apache2 -D FOREGROUND&#39;
</code></pre><p>Press <code>ctrl-c</code> to interrupt the <code>docker logs...</code> command and get your terminal back.</p><h2 id=some-settings-are-missing>Some Settings Are Missing</h2><p>I found some settings were missing the first time I started the stack like this. A little research and debugging led me to believe that not all of the required configuration commands had been executed properly. In particular, I found that my large image (TIFF image) viewer wasn&rsquo;t displaying anything at all, presumably because the database I imported from production was setup to use Adore-Djatoka, not IIIF Cantaloupe. The remedy was to take a snapshot of the server, then run the required <code>migration_site_vsets.sh</code> script inside the <em>Apache</em> container. Unfortunately that didn&rsquo;t work for me at first and I got lots of messages indicating that <code>Command variable-set needs a higher bootstrap level to run...</code>. That error basically means that the <code>drush</code> commands inside the script need to be run from the appropriate directory so that <code>drush</code> can find the site and its database. So, to run it properly inside the <em>Apache</em> container&mldr;</p><table><thead><tr><th>Apache Container Commands</th></tr></thead><tbody><tr><td>cd /var/www/html/sites/default<br>/utility-scripts/isle_drupal_build_tools/migration_site_vsets.sh</td></tr></tbody></table><p>Note the <code>cd</code> command and path before the script is run, and there&rsquo;s no &ldquo;dot&rdquo; in front of <code>/utility-scripts...</code>. This time everything worked except for a <code>phpmailerException</code> at the end of the run, but that&rsquo;s of no consequence, and to be expected since this is a staging server and has no mail facilities of its own.</p><p>A quick visit to <a href=https://isle-stage.grinnell.edu%5D>the staging site</a> shows that large images (for example see <a href=https://isle-stage.grinnell.edu/islandora/object/grinnell:25511>https://isle-stage.grinnell.edu/islandora/object/grinnell:25511</a>) are working properly. It sure would be nice to have an automated test to verify that for me, automatically&mldr; but we&rsquo;ll address that issue a little later in this post. üòÑ</p><h2 id=backup-the-site-database>Backup the Site Database</h2><p>For now, let&rsquo;s just make a backup of the site database for safe-keeping. We can do this by visiting the <a href=https://isle-stage.grinnell.edu>site&rsquo;s home page</a> and using the <code>Quick Backup</code> block at the bottom of the right-hand sidebar and selecting <code>Backup Destination: Manual Backups Directory</code>. This operation makes a backup of the site database and stores it in a pre-determined place&mldr; in our case the <code>docker-compose.staging.yml</code> configuration file tells us that it&rsquo;s stored somewhere in <code>/mnt/data/DG-FEDORA/site-public</code>. More specifically, this backup is <code>/mnt/data/DG-FEDORA/site-public/backup_migrate/manual/DigitalGrinnell-2019-12-17T15-03-10.mysql.gz</code> on the host, <code>DGDockerX</code>.</p><h2 id=missing-cmodels-and-no-pdf-viewer>Missing CModels and No PDF Viewer</h2><p>While visiting the site moments ago I noticed two more issues:</p><ul><li>At <a href=https://isle-stage.grinnell.edu/admin/islandora/solution_pack_config/solution_packs>https://isle-stage.grinnell.edu/admin/islandora/solution_pack_config/solution_packs</a> the Binary cModel is missing, and</li><li>A visit to <a href=https://isle-stage.grinnell.edu/islandora/object/grinnell:25500>https://isle-stage.grinnell.edu/islandora/object/grinnell:25500</a> shows a JPEG image of a single page, but since this object is a multi-page PDF, we are obviously missing our PDF viewer.</li></ul><p>So, remember back in the <a href=https://static.grinnell.edu/dlad-blog/posts/058-rebuilding-isle-ld/installing-the-missing-islandora-and-custom-modules>Installing the Missing Islandora and Custom Modules</a> section of <a href=https://static.grinnell.edu/dlad-blog/posts/058-rebuilding-isle-ld/>post 058</a>, we commented out the installation of <code>islandora_binary_object</code> and <code>islandora_pdfjs_reader</code> like so:</p><pre tabindex=0><code>cd /var/www/html/sites/all/modules/islandora
git submodule add https://github.com/DigitalGrinnell/dg7.git
git submodule add https://github.com/DigitalGrinnell/idu.git
# git submodule add git://github.com/discoverygarden/islandora_binary_object.git
git submodule add https://github.com/discoverygarden/islandora_collection_search
git submodule add https://github.com/DigitalGrinnell/islandora_mods_display.git
git submodule add https://github.com/Islandora-Labs/islandora_solution_pack_oralhistories.git
# git submodule add git://github.com/nhart/islandora_pdfjs_reader.git
git submodule add https://github.com/Islandora-Labs/islandora_solr_collection_view.git
chown -R islandora:www-data *
cd /var/www/html/sites/default
drush cc all
</code></pre><p>Well, it&rsquo;s evidently time to put them back! So, I&rsquo;m taking a new snapshot of the server then I&rsquo;ll try to solve this mystery. A little research tells me that the <code>islandora_binary_object</code> command above is pointing to the wrong project for Islandora v7 (it points to an Islandora v8 module). Also, the <code>islandora_pdfjs_reader</code> module has apparently been replaced by <code>islandora_pdfjs</code>, and it just requires some additional configuration. So, the entire command stream on the host should be:</p><table><thead><tr><th>Host / DGDockerX Commands</th></tr></thead><tbody><tr><td>sudo su<br>cd /opt/dg-islandora<br>git submodule add <a href=https://github.com/Islandora-Labs/islandora_binary_object>https://github.com/Islandora-Labs/islandora_binary_object</a> sites/all/modules/islandora/islandora_binary_object<br>chown -R islandora:www-data *</td></tr></tbody></table><p>A look at the <code>Installation</code> and <code>Configuration</code> guidance provided in the <a href=https://github.com/Islandora/islandora_pdfjs>islandora_pdfjs module&rsquo;s README.md file</a> suggests that I need to do a little more work in the <em>Apache</em> container so I did as it said, then selected the new PDF viewer at</p><p>Then taking a look at our example PDF object, <a href=https://isle-stage.grinnell.edu/islandora/object/grinnell:25500>https://isle-stage.grinnell.edu/islandora/object/grinnell:25500</a>, shows that it works!</p><h2 id=binary-objects>Binary Objects</h2><p>The <a href=https://github.com/discoverygarden/islandora_binary_object>https://github.com/discoverygarden/islandora_binary_object</a> repository that <em>Digital.Grinnell</em> formerly used is now home to an <em>Islandora</em> version 8 module. :sad: That won&rsquo;t do. Fortuntely, there is a version 7 copy of the old binary content model residing at <a href=https://github.com/Islandora-Labs/islandora_binary_object>https://github.com/Islandora-Labs/islandora_binary_object</a>.</p><p>There&rsquo;s no mention of <code>islandora_binary_object</code> in the host&rsquo;s <code>/opt/dg-islandora/.gitmodules</code> file, so lets add this submodule with the following commands executed from the host:</p><table><thead><tr><th>Host / DGDockerX Commands</th></tr></thead><tbody><tr><td>sudo su<br>cd /opt/dg-islandora<br>git submodule add <a href=https://github.com/Islandora-Labs/islandora_binary_object>https://github.com/Islandora-Labs/islandora_binary_object</a> sites/all/modules/islandora/islandora_binary_object<br>chown -R mcfatem:33 sites/all/modules/islandora/.</td></tr></tbody></table><p>Next step then is to enable the new module, and I did this by visiting <a href=https://isle-stage.grinnell.edu/admin/modules>the site&rsquo;s module administration page</a>. But when I toggled the <code>Islandora Binary Object Storage</code> on and submitted the form I got this:</p><pre tabindex=0><code>DatabaseSchemaObjectExistsException: Table islandora_binary_object_thumbnail_associations already exists. in DatabaseSchema-&gt;createTable() (line 663 of /var/www/html/includes/database/schema.inc).
DatabaseSchemaObjectExistsException: Table islandora_binary_object_thumbnail_mappings already exists. in DatabaseSchema-&gt;createTable() (line 663 of /var/www/html/includes/database/schema.inc).
</code></pre><p>Apparently the offending tables, presumably database leftovers from the production site, need to be removed before the new module can be installed. So, in the <em>Apache</em> container I&rsquo;ll run this:</p><table><thead><tr><th>Apache Container Commands</th></tr></thead><tbody><tr><td>cd /var/www/html/sites/default<br>drush sql-query &ldquo;drop table islandora_binary_object_thumbnail_associations&rdquo;<br>drush sql-query &ldquo;drop table islandora_binary_object_thumbnail_mappings&rdquo;<br>drush dis islandora_binary_object -y<br>drush en islandora_binary_object -y<br>drush cc all</td></tr></tbody></table><p>That seems to have done the trick. I&rsquo;ll test it in the morning to confirm, right after another database backup.</p><h2 id=backup-the-site-database-again>Backup the Site Database, Again</h2><p>Once again, we will visit the <a href=https://isle-stage.grinnell.edu>site&rsquo;s home page</a> and use the <code>Quick Backup</code> block at the bottom of the right-hand sidebar and selecting <code>Backup Destination: Manual Backups Directory</code>. This time our backup is <code>/mnt/data/DG-FEDORA/site-public/backup_migrate/manual/DigitalGrinnell-2019-12-18T21-14-02.mysql.gz</code> on the host, <code>DGDockerX</code>.</p><p>Not quite a wrap. Be back soon&mldr;</p></div><div class=post-footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//digital-library-applications-developer-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></main></body></html>