<!doctype html><html lang=en-us><head><title>Adding `.htaccess` to Apache Container `/tmp` Directory // The Grinnell College Digital Library Application Developer's Blog</title><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Mark A. McFate"><meta name=description content><link rel=stylesheet href=https://static.grinnell.edu/dlad-blog/css/main.min.bc1abb622a656fb4c816fed09d36c15e272b31b7beae2e7113b2f9418bff0361.css><script type=text/javascript src=https://static.grinnell.edu/dlad-blog/js/pdf-js/build/pdf.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Adding `.htaccess` to Apache Container `/tmp` Directory"><meta name=twitter:description content="For some time now we&rsquo;ve had a problem lurking in Digital.Grinnell, when large files are opened for viewing or download one of the DG services makes a temporary copy of the file in the Apache container&rsquo;s /tmp directory. Locally, and in staging I&rsquo;ve debugged the code that is responsible for removing the temporary file once the operation is complete. Running locally or in staging the process does its job, the temporary files get deleted soon after creation, but this never happens in production."><meta property="og:title" content="Adding `.htaccess` to Apache Container `/tmp` Directory"><meta property="og:description" content="For some time now we&rsquo;ve had a problem lurking in Digital.Grinnell, when large files are opened for viewing or download one of the DG services makes a temporary copy of the file in the Apache container&rsquo;s /tmp directory. Locally, and in staging I&rsquo;ve debugged the code that is responsible for removing the temporary file once the operation is complete. Running locally or in staging the process does its job, the temporary files get deleted soon after creation, but this never happens in production."><meta property="og:type" content="article"><meta property="og:url" content="https://static.grinnell.edu/dlad-blog/posts/105-adding-htaccess-to-apache-tmp-directory/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-04-14T15:23:45-05:00"></head><body><header class=app-header><a href=https://static.grinnell.edu/dlad-blog/><img class=app-header-avatar src=https://static.grinnell.edu/dlad-blog/avatar.jpg alt="Mark A. McFate"></a><h2>The Grinnell College Digital Library Application Developer's Blog</h2><div class=author-block><p class=site-rev>Compiled: Feb 17, 2023 at 2:33pm CST<br>Content Updated: 2023-Feb-16 13:07 CST</p><div class=name>by
<strong>Mark A. McFate</strong></div><div class=address>Grinnell College Libraries</div><div class=link><a href=mailto:></a></div><br></div><nav class=sidebar-nav><a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/search/ title>Search This Blog</a>
<a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/about/ title>About Me</a></nav><p class=site-description>Mark&rsquo;s first Hugo site, a blog, formerly on prem at Static.Grinnell.edu, moved to <em>DigitalOcean</em>, then to <em>Azure</em>, and now hosted on <em>GitHub Pages</em>.</p><div class=app-header-social><a target=_blank href=https://github.com/McFateM><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/gohugoio><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div><p class=copyright>The views and opinions expressed on this site belong solely to the original author(s) and do not necessarily represent or reflect those of Grinnell College.</p></header><main class=app-container><div class=breadcrumbs><a href=https://static.grinnell.edu/dlad-blog/>Home</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/>Posts</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/105-adding-htaccess-to-apache-tmp-directory/>105 adding htaccess to apache tmp directory</a></div><article class=post><header class=post-header><h1 class=post-title>Adding `.htaccess` to Apache Container `/tmp` Directory</h1><div class=post-meta><script>console.log("Hugo Debug: ",JSON.parse('"2021-04-15T00:00:00Z"'))</script><script>console.log("Hugo Debug: ",JSON.parse('"2021-04-14T15:23:45-05:00"'))</script><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Apr 14, 2021
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<strong><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign"><title>at-sign</title><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg> Mark A. McFate</strong><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/tmp/>tmp</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/temporary/>temporary</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/apache/>Apache</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/.htaccess/>.htaccess</a></div></div></header><div class=post-content><p>For some time now we&rsquo;ve had a problem lurking in <a href=https://digital.grinnell.edu>Digital.Grinnell</a>, when large files are opened for viewing or download one of the <em>DG</em> services makes a temporary copy of the file in the <em>Apache</em> container&rsquo;s <code>/tmp</code> directory. Locally, and in staging I&rsquo;ve debugged the code that is responsible for removing the temporary file once the operation is complete. Running locally or in staging the process does its job, the temporary files get deleted soon after creation, but this never happens in production. The result, our root disk on the production server fills up after a few days of use, and the server stops serving content. Even more sinister, the server doesn&rsquo;t crash and restart &ndash; a condition that would also clear the offending <code>/tmp</code> files &ndash; it doesn&rsquo;t even report a fatal error, it just refuses to serve content, which is really its only function. Very frustrating indeed!</p><p>So I&rsquo;ve set a reminder to bring the <em>DG</em> stack down, gracefully, every few days, and immediately restart it. This works nicely becuase stopping and restarting the stack clears out all temporary files.</p><h2 id=whats-different-about-staging>What&rsquo;s Different About Staging?</h2><p>This afternoon I was poking around in my staging server, <a href=https://dg-staging.grinnell.edu>https://dg-staging.grinnell.edu</a>, and noticed something different in the <em>Apache</em> container&rsquo;s <code>/tmp</code> directory there. The folder contains a <code>.htaccess</code> file, one that does NOT exist in production. Hmmm.</p><p>The other <strong>glaring</strong> difference is that in staging the <em>Apache</em> <code>/tmp</code> directory is owned by UID <code>islandora</code>, as is most everything in staging. In production, however, that directory is owned by <code>root</code>. Hmmmm, very interesting indeed.</p><h2 id=first-attempt-a-new-htaccess-file>First Attempt, a New .htaccess File</h2><p>So my first move was to duplicate the <code>.htaccess</code> file I found in staging and add it to production&rsquo;s <em>Apache</em> <code>/tmp</code> directory. After watching <em>DG</em> performance for a bit I could see this was having no effect, almost immediately some very large, temporary files started to accumulate. Rats.</p><h2 id=changing-tmp-ownership>Changing <code>/tmp</code> Ownership</h2><p>Since the permissions on the <code>/tmp</code> directory looked right my next move was to change the ownership of <code>/tmp</code>. I did that after shelling in to the running <em>Apache</em> container, like so:</p><pre tabindex=0><code>docker exec -it isle-apache-dg bash
cd /
ls -alh
chown -R www-data:www-data tmp
</code></pre><h2 id=did-that-work>Did That Work?</h2><p>Only ðŸ•° will tell! After about 10 minutes time there&rsquo;s no evidence of any temporary files accumulating. ðŸ˜„</p></div><div class=post-footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//digital-library-applications-developer-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></main></body></html>