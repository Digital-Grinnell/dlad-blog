<!doctype html><html lang=en-us><head><title>Production ISLE Installation: Migrate Existing Islandora Site - with Annotations // The Grinnell College Digital Library Application Developer's Blog</title><meta charset=utf-8><meta name=generator content="Hugo 0.96.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Mark A. McFate"><meta name=description content><link rel=stylesheet href=https://static.grinnell.edu/dlad-blog/css/main.min.ec5c8abc0625bee34a87b8624d3c683035583f8314d537f8d266c9f01ad58d83.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Production ISLE Installation: Migrate Existing Islandora Site - with Annotations"><meta name=twitter:description content="Attention: Take note that annotations stop where my process departed from this script in Step 16. Enter at your own risk beyond the annotation in Step 16!
 -- This post is an addendum to earlier post 092. It is intended to chronicle my efforts to complete migration of our production instance of Digital.Grinnell from ISLE v1.1 to ISLE v1.5.1 on Linux node DGDocker1.grinnell.edu. The remainder of this document is an annotated copy of Production ISLE Installation: Migrate Existing Islandora Site."><meta property="og:title" content="Production ISLE Installation: Migrate Existing Islandora Site - with Annotations"><meta property="og:description" content="Attention: Take note that annotations stop where my process departed from this script in Step 16. Enter at your own risk beyond the annotation in Step 16!
 -- This post is an addendum to earlier post 092. It is intended to chronicle my efforts to complete migration of our production instance of Digital.Grinnell from ISLE v1.1 to ISLE v1.5.1 on Linux node DGDocker1.grinnell.edu. The remainder of this document is an annotated copy of Production ISLE Installation: Migrate Existing Islandora Site."><meta property="og:type" content="article"><meta property="og:url" content="https://static.grinnell.edu/dlad-blog/posts/096-production-isle/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-20T00:00:00+00:00"><meta property="article:modified_time" content="2020-11-23T08:15:24-06:00"></head><body><header class=app-header><a href=https://static.grinnell.edu/dlad-blog/><img class=app-header-avatar src=https://static.grinnell.edu/dlad-blog/avatar.jpg alt="Mark A. McFate"></a><h2>The Grinnell College Digital Library Application Developer's Blog</h2><div class=author-block><p class=site-rev>Compiled: Mar 29, 2022 at 2:08pm CDT<br>Content Updated: 2022-Mar-24 00:00 UTC</p><div class=name>by
<strong>Mark A. McFate</strong></div><div class=address>Grinnell College Libraries</div><div class=link><a href=mailto:></a></div><br></div><nav class=sidebar-nav><a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/search/ title>Search This Blog</a>
<a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/about/ title>About Me</a></nav><p class=site-description>Mark's first Hugo site, a blog, formerly at Static.Grinnell.edu, moved to DigitalOcean, and now hosted on Azure.</p><div class=app-header-social><a target=_blank href=https://github.com/McFateM><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/gohugoio><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div><p class=copyright>The views and opinions expressed on this site belong solely to the original author(s) and do not necessarily represent or reflect those of Grinnell College.</p></header><main class=app-container><div class=breadcrumbs><a href=https://static.grinnell.edu/dlad-blog/>Home</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/>Posts</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/096-production-isle/>096 production isle</a></div><article class=post><header class=post-header><h1 class=post-title>Production ISLE Installation: Migrate Existing Islandora Site - with Annotations</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>39 min read
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Nov 20, 2020
&nbsp;&nbsp;&bull;&nbsp;&nbsp;Updated: Nov 23, 2020 - 08:15
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<strong><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign"><title>at-sign</title><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg> Mark A. McFate</strong><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/isle/>ISLE</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/migrate/>Migrate</a><a class=tag href=https://static.grinnell.edu/dlad-blog/tags/production/>production</a></div></div></header><div class=post-content><p>This post is an addendum to earlier post <a href=https://static.grinnell.edu/dlad-blog/posts/092-staging-isle/>092</a>. It is intended to chronicle my efforts to complete migration of our production instance of <a href=https://digital.grinnell.edu>Digital.Grinnell</a> from ISLE v1.1 to ISLE v1.5.1 on Linux node <code>DGDocker1.grinnell.edu</code>. The remainder of this document is an annotated copy of <a href=https://github.com/Islandora-Collaboration-Group/ISLE/blob/master/docs/install/install-production-migrate.md>Production ISLE Installation: Migrate Existing Islandora Site</a>.</p><div class=annotation><p>Annotations, with information specific to my experience with <em>Digital.Grinnell</em> migration, appear in text blocks like this one.</p></div><h1 id=production-isle-installation-migrate-existing-islandora-site>Production ISLE Installation: Migrate Existing Islandora Site</h1><p><em>Expectations: It takes an average of <strong>2-4+ hours</strong> to read this documentation and complete this installation.</em></p><p>This Production ISLE Installation will be similar to the <a href=../install/install-local-migrate.md>Local ISLE Installation: Migrate Existing Islandora Site</a> instructions you just followed but in addition to using a copy of your currently running Production themed Drupal website, a copy of the Production Fedora repository will also be needed for you to continue migrating to ISLE with the end goal of first deploying to an ISLE Production environment and then cut over from the existing non-ISLE Production and Production servers to their new ISLE counterparts.</p><p>Islandora Drupal site code here should be finished and ready for public consumption. Fedora data will be a mirror of your currently running non-ISLE Production Fedora repository. It is recommended that this remote site not be publicly accessible until you are ready to cutover and give public access.</p><p>This installation builds a Production environment for the express purpose of migrating a previously existing Islandora site onto the ISLE platform. If you need to build a brand new Production site for development and are not migrating an existing Islandora site, then please <strong>stop</strong> and use the <a href=../install/install-production-new.md>Production ISLE Installation: New Site</a> instead.</p><p>As this Production domain will require a real domain name or <a href=https://kb.iu.edu/d/aiuv>FQDN</a>, you will need to ask your IT department or appropriate resource for an &ldquo;A record&rdquo; to be added for your domain to &ldquo;point&rdquo; to your Production Host Server IP address in your institution&rsquo;s DNS records.</p><p>Example: <code>https://yourprojectnamehere.institution.edu</code></p><p>Once this has been completed, if you do not want to use Let&rsquo;s Encrypt, you can also request commercial SSL certificates from your IT department for this domain as well. Please note the DNS records will need to exist prior to the creation of any SSL certificate (Commercial or Let&rsquo;s Encrypt.)</p><ul><li>If you already have pre-existing Production commercial SSL certificates, they can certainly be reused and copied into the ISLE project as directed.</li></ul><p>Unlike the Local and Demo setups, you will not have to edit <code>/etc/localhosts</code> to view your domain given that DNS is now involved. Your new domain will no longer use the <code>.localdomain</code> but instead something like <code>https://yourprojectnamehere.institution.edu</code></p><p>This document also has directions on how you can save newly updated ISLE code into a git software repository as a workflow process designed to manage and upgrade the environments throughout the development process from Local to Production and finally to Production. The <a href=../install/install-environments.md>ISLE Installation: Environments</a> documentation can also help with explaining the new ISLE structure, the associated files and what values ISLE end-users should use for the <code>.env</code>, <code>production.env</code>, etc.</p><p>This document <strong>does not</strong> have directions on how you can save previously existing Islandora Drupal code into a git repository and assumes this step has already happened. The directions below will explain how to clone Islandora Drupal code from a previously existing Islandora Drupal git repository that should already be accessible to you.</p><p>Please post questions to the public <a href=https://groups.google.com/forum/#!forum/islandora-isle>Islandora ISLE Google group</a>, or subscribe to receive emails. The <a href=../appendices/glossary.md>Glossary</a> defines terms used in this documentation.</p><h2 id=assumptions--prerequisites>Assumptions / Prerequisites</h2><ul><li><p>This Production ISLE installation is intended for an existing Production Islandora Drupal site to be imported along with a copy of the current Production Fedora Repository for further ISLE migration testing, Drupal theme development, ingest testing, etc. on a remote ISLE host server.</p><ul><li>Some materials are to be &ldquo;migrated&rdquo; from the work you performed on your personal computer from the prior steps and processes in <a href=../install/install-local-migrate.md>Local ISLE Installation: Migrate Existing Islandora Site</a> instructions.</li></ul></li><li><p>You will be using ISLE version <strong>1.2.0</strong> or higher.</p></li><li><p>You are using Docker-compose <strong>1.24.0</strong> or higher.</p></li><li><p>You have git installed on your personal computer as well as the remote ISLE host server.</p></li><li><p>You have already provisioned a remote ISLE hosts server and have documented its IP address.
* You may have used the <a href=https://github.com/Islandora-Collaboration-Group/ISLE-Ansible>ISLE Ansible script</a> to accomplish this.
* If doing this manually, please review the following to ensure the remote Production ISLE host server has all dependencies e.g. CPU, memory and disk space prior to deploying the ISLE Production environment profile for deploy
* <a href=host-hardware-requirements.md>Hardware Requirements</a>
* <a href=host-software-dependencies.md>Software Dependencies</a>
* This server should be running at the time of deploy.
* <strong>Critical</strong> - This Production server has the same amount of disk space as your current Production Fedora server does in order to store a copy of the Fedora repository. Please ensure that these sizes match. Please also plan on adding additional capacity as needed for any potential ingest testing, etc.</p></li><li><p>You have a previously existing private Islandora Drupal git repository.</p></li><li><p>You have access to a private git repository in <a href=https://github.com>Github</a>, <a href=https://bitbucket.org/>Bitbucket</a>, <a href=https://gitlab.com>Gitlab</a>, etc.</p><ul><li>If you do not, please contact your IT department for git resources, or else create an account with one of the above providers.</li><li><strong>WARNING:</strong> Only use <strong>Private</strong> git repositories given the sensitive nature of the configuration files. <strong>DO NOT</strong> share these git repositories publicly.</li></ul></li><li><p>You have already have the appropriate A record entered into your institutions DNS system and can resolve the Production domain (<a href=https://yourprojectnamehere.institution.edu>https://yourprojectnamehere.institution.edu</a>) using a tool like <a href=https://www.whatsmydns.net/>https://www.whatsmydns.net/</a></p></li><li><p><strong>RECOMMENDATION:</strong> We recommend that you use a temporary domain name e.g. <code>https://yourprojectnamehere-newprod.institution.edu</code> to check the new Production ISLE site while an existing non-ISLE Production site is still running and compare for differences. This will also allow end users to still access the old Production system while the work for the new ISLE system is ongoing.</p><ul><li>You&rsquo;ll need to add an additional A record for <code>yourprojectnamehere-newprod.institution.edu</code> to point to the same ISLE Production Host Server IP.</li><li>Please adjust all involved domain names and configuration files accordingly.</li><li>When ready to launch the new ISLE production site publicly, you can remove the <code>-newprod</code> from all domain references and configuration files.<ul><li>Update the DNS records to repoint the current non-ISLE Production server A record for <code>yourprojectnamehere.institution.edu</code> to the new ISLE host server IP.</li><li>Remove the temporary DNS A record for <code>yourprojectnamehere-newprod.institution.edu</code></li><li>If using commercial SSLs, you&rsquo;ll also need to copy them over to the <code>./config/proxy/ssl-certs</code> directory and adjust the <code>traefik.production.toml</code> file accordingly with the new file names.</li></ul></li></ul></li><li><p>You have reviewed the <a href=../install/install-environments.md>ISLE Installation: Environments</a> for more information about suggested Production values.</p></li><li><p>You are familiar with using tools like <code>scp, cp or rsync</code> to move configurations, files and data from your local to the remote Production server.</p></li><li><p>You have access to your Production Islandora Drupal, Solr and Fedora data and copy from your servers to the new ISLE Production server.</p></li><li><p>You will schedule a content freeze for all Production Fedora ingests and additions to your Production website. This will allow you to get up to date data from Production to Production.</p></li></ul><hr><h2 id=index-of-instructions>Index of Instructions</h2><p>This process will differ slightly from previous builds in that there is work to be done on the local to then be pushed to the Production ISLE Host server with additional followup work to be performed on the remote Production ISLE Host server.</p><p>The instructions that follow below will have either a <code>On Local</code> or a <code>On Remote Production</code> pre-fix to indicate where the work and focus should be. In essence, the git workflow established during the local build process will be extended for deploying on Production and for future ISLE updates and upgrades.</p><p><strong>Steps 1-6: On Local - Configure the ISLE Production Environment Profile for Deploy to Remote</strong></p><ul><li>Step 1: Copy Production Data to Your Local</li><li>Step 2: On Local - Shutdown Any Local Containers & Review Local Code</li><li>Step 3: On Local - Create New Users and Passwords by Editing &ldquo;production.env&rdquo;</li><li>Step 4: On Local - Review and Edit &ldquo;docker-compose.production.yml&rdquo;</li><li>Step 4A: On Local - (Optional) Changes for &ldquo;docker-compose.production.yml&rdquo;</li><li>Step 5: On Local Production - If Using Commercial SSLs</li><li>Step 6: On Local - Commit ISLE Code to Git Repository</li></ul><p><strong>Steps 7-18: On Remote Production - Configure the ISLE Production Environment Profile for Launch and Usage</strong></p><ul><li>Step 7: On Remote Production - Git Clone the ISLE Repository to the Remote Production ISLE Host Server</li><li>Step 8: On Remote Production - Create the Appropriate Local Data Paths for Apache, Fedora and Log Data</li><li>Step 9: On Remote Production - Clone Your Production Islandora Code</li><li>Step 10: On Remote Production - Copy Over the Production Data Directories</li><li>Step 11: On Remote Production - If Using Let&rsquo;s Encrypt</li><li>Step 12: On Remote Production - Edit the &ldquo;.env&rdquo; File to Change to the Production Environment</li><li>Step 13: On Remote Production - Download the ISLE Images</li><li>Step 14: On Remote Production - Start Containers</li><li>Step 15: On Remote Production - Import the Production MySQL Drupal Database</li><li>Step 16: On Remote Production - Run ISLE Scripts</li><li>Step 17: On Remote Production - Re-Index Fedora & Solr</li><li>Step 18: On Remote Production - Review and Test the Drupal Production Site</li></ul><hr><h2 id=step-1-copy-production-data-to-your-local>Step 1: Copy Production Data to Your Local</h2><h3 id=drupal-site-database>Drupal Site Database</h3><p>You are repeating this step given that data may have changed on the Production site since creating your local. It is critical that Production be a mirror or close to exact copy of Production.</p><p><strong>Prior to attempting this step, please consider the following:</strong></p><ul><li><p>Drupal website databases can have a multitude of names and conventions. Confer with the appropriate IT departments for your institution&rsquo;s database naming conventions.</p></li><li><p>Recommended that the production databases be exported using the <code>.sql</code> /or <code>.gz</code> file formats (e.g. &ldquo;prod_drupal_site_082019.sql.gz&rdquo;) for better compression and minimal storage footprint.</p></li><li><p>If the end user is running multi-sites, there will be additional databases to export.</p></li><li><p>Do not export the <code>fedora3</code> database</p></li><li><p>If possible, on the production Apache web server, run <code>drush cc all</code> from the command line on the production server in the <code>/var/www/html</code> directory PRIOR to any db export(s). Otherwise issues can occur on import due to all cache tables being larger than <code>innodb_log_file_size</code> allows</p></li></ul><h4 id=export-the-production-mysql-islandora-drupal-database>Export the Production MySQL Islandora Drupal Database</h4><ul><li>Export the MySQL database for the current Production Islandora Drupal site in use and copy it to your local in an easy to find place. In later steps you&rsquo;ll be directed to import this file. <strong>Please be careful</strong> performing any of these potential actions below as the process impacts your Production site. If you are not comfortable or familiar with performing these actions, we recommend that you instead work with your available IT resources to do so.<ul><li>To complete this process, you may use a MySQL GUI client or, if you have command line access to the MySQL database server, you may run the following command, substituting your actual user and database names:</li><li><strong>Example:</strong> <code>mysqldump -u username -p database_name > prod_drupal_site_082019.sql</code></li><li>Copy this file down to your personal computer.</li></ul></li></ul><div class=annotation><p>I started this process by creating an intermediate storage directory on <code>DGDocker1</code> at <code>~/DG-PROD/data</code>, that&rsquo;s <code>/home/islandora/DG-PROD/data</code>. I subsequently used the following commands to dump the production database and capture necessary artifacts from production:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ~/DG-PROD/files
</span></span><span style=display:flex><span>rsync -aruvi /opt/ISLE/persistent/html/sites/default/files/. ~/DG-PROD/data/files/. --progress
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir -p ~/DG-PROD/data/config/proxy
</span></span><span style=display:flex><span>cp -fr /opt/ISLE/config/proxy/. ~/DG-PROD/data/config/proxy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker exec -it isle-mysql-dg bash
</span></span><span style=display:flex><span>  mysqldump -u isle_dg_user -p isle_dg &gt; prod_drupal_site_112220.sql
</span></span><span style=display:flex><span>  exit
</span></span><span style=display:flex><span>docker cp isle-mysql-dg:prod_drupal_site_112220.sql ~/DG-PROD/data/prod_drupal_site_112220.sql
</span></span></code></pre></div></div><hr><h2 id=step-2-on-local---shutdown-any-local-containers--review-local-code>Step 2: On Local - Shutdown Any Local Containers & Review Local Code</h2><div class=annotation><p>I found this step to be <strong>UNECESSARY</strong> since my <code>dg-isle</code> and <code>dg-islandora</code> repositories have already been prepared. However, see below&mldr;</p></div><ul><li><p>Ensure that your ISLE and Islandora git repositories have all the latest commits and pushes from the development process that took place on your personal computer. If you haven&rsquo;t yet finished, do not proceed until everything is completed.</p></li><li><p>Once finished, open a <code>terminal</code> (Windows: open <code>Git Bash</code>)</p><ul><li>Navigate to your Local ISLE repository</li><li>Shut down any local containers e.g. <code>docker-compose down</code></li></ul></li></ul><div class=annotation><p>I <strong>did</strong> take this opportunity to <code>docker-compose down</code> from <code>DGDocker1</code> in the <code>/opt/ISLE/</code> directory. Unfortunately, the command was unable to stop the <code>isle-images-dg</code> container, and failed to stop any others apart from <em>Portaioner</em>. The output was:</p><pre tabindex=0><code>ERROR: for isle-images-dg  UnixHTTPConnectionPool(host=&#39;localhost&#39;, port=None): Read timed out. (read timeout=70)
ERROR: An HTTP request took too long to complete. Retry with --verbose to obtain debug information.
If you encounter this issue regularly because of slow network conditions, consider setting COMPOSE_HTTP_TIMEOUT to a higher value (current value: 60).
</code></pre><p>Even with COMPOSE_HTTP_TIMEOUT set to a much higher value, I was unable to stop the stack with <code>docker-compose down</code>. So I tried <code>docker stop 063</code>, where &ldquo;063&rdquo; was the first three digits of the <code>isle-images-dg</code> container. <strong>This also FAILED!</strong></p><p>As a last resort I tried and failed, again, with:</p><pre tabindex=0><code>[islandora@dgdocker1 ISLE]$ docker rm -f 063312b1d155
Error response from daemon: removal of container 063312b1d155 is already in progress
</code></pre><p>So, I consulted <em>StackOverflow</em> and found a post that suggested the following:</p><pre tabindex=0><code>[islandora@dgdocker1 ISLE]$ ps aux | grep 063312b1d155
root       5563  0.0  0.0 108744  6636 ?        Sl   May05   8:16 containerd-shim -namespace moby -workdir /var/lib/containerd/io.containerd.runtime.v1.linux/moby/063312b1d155e129740c040d47cb84a01556c1cc1c89821d695cb314ac7415da -address /run/containerd/containerd.sock -containerd-binary /usr/bin/containerd -runtime-root /var/run/docker/runtime-runc
islando+ 108134  0.0  0.0 112716   968 pts/2    S+   16:57   0:00 grep --color=auto 063312b1d155
</code></pre><p>And that lead me to try:</p><pre tabindex=0><code>[islandora@dgdocker1 ISLE]$ sudo kill -9 5563
[islandora@dgdocker1 ISLE]$ docker-compose down
Stopping isle-apache-dg ...
Stopping isle-fedora-dg ... error
Stopping isle-solr-dg   ... error
Stopping isle-mysql-dg  ... error
Stopping isle-proxy-dg  ... error

ERROR: for isle-apache-dg  UnixHTTPConnectionPool(host=&#39;localhost&#39;, port=None): Read timed out. (read timeout=70)
ERROR: An HTTP request took too long to complete. Retry with --verbose to obtain debug information.
If you encounter this issue regularly because of slow network conditions, consider setting COMPOSE_HTTP_TIMEOUT to a higher value (current value: 60).
</code></pre><p>Having exhausted all reasonable options, I elected to use vCenter to reboot the <code>DGDocker1</code> server. But first, for safe-keeping&mldr;</p><pre tabindex=0><code>sudo rsync -aruvi ~/DG-PROD/. /mnt/storage/DG-PROD/. --progress
</code></pre><p>After this I shut down the guest OS on <code>DGDocker1</code> using <code>vCenter</code>, then restarted it, and the server came back but without running any Docker containers. So I did <code>sudo yum update</code>, then <code>sudo yum upgrade</code>, and rebooted. The server now reports that it is up-to-date and running this:</p><pre tabindex=0><code>Server: Docker Engine - Community
 Engine:
  Version:          19.03.13
  API version:      1.40 (minimum version 1.12)
  Go version:       go1.13.15
  Git commit:       4484c46d9d
  Built:            Wed Sep 16 17:02:21 2020
  OS/Arch:          linux/amd64
  Experimental:     false
</code></pre></div><hr><h2 id=step-3-on-local---create-new-users-and-passwords-by-editing-productionenv>Step 3: On Local - Create New Users and Passwords by Editing &ldquo;production.env&rdquo;</h2><div class=annotation><p>I found this step to be <strong>UNECESSARY</strong> since my <code>dg-isle</code> and <code>dg-islandora</code> repositories have already been prepared.</p></div><ul><li><p>Open the &ldquo;production.env&rdquo; file in a text editor.</p><ul><li>Find each comment that begins with: <code># Replace this comment with a ...</code> and follow the commented instructions to edit the passwords, database and user names.<ul><li><strong>Review carefully</strong> as some comments request that you replace with <code>...26 alpha-numeric characters</code> while others request that you create an <code>...easy to read but short database name</code>.</li><li>It is okay if you potentially repeat the values previously entered for your local <code>(DRUPAL_DB)</code> & <code>(DRUPAL_DB_USER)</code> in this Production environment but we strongly recommend not reusing all passwords for environments (e.g. <code>(DRUPAL_DB_PASS)</code> & <code>(DRUPAL_HASH_SALT)</code> should be unique values for each environment).</li><li>In many cases the username is already pre-populated. If it doesn&rsquo;t have a comment directing you to change or add a value after the <code>=</code>, then don&rsquo;t change it.</li></ul></li><li>Once finished, save and close the file.</li></ul></li><li><p>Open the <code>config/apache/settings_php/settings.production.php</code> file.</p><ul><li>Find the first comment that begins with: <code># ISLE Configuration</code> and follow the commented instructions to edit the database, username and password.</li><li>Find the second comment that begins with: <code># ISLE Configuration</code> and follow the instructions to edit the Drupal hash salt.</li><li>Once finished, save and close the file.</li></ul></li></ul><hr><h2 id=step-4-on-local---review-and-edit-docker-composeproductionyml>Step 4: On Local - Review and Edit &ldquo;docker-compose.production.yml&rdquo;</h2><div class=annotation><p>I found this step to be <strong>UNECESSARY</strong> since my <code>dg-isle</code> and <code>dg-islandora</code> repositories have already been prepared.</p></div><ul><li><p>Review the disks and volumes on your remote Production ISLE Host server to ensure they are of an adequate capacity for your collection needs and match what has been written in the <code>docker-compose.production.yml</code> file.</p></li><li><p>Please read through the <code>docker-compose.production.yml</code> file as there are bind mount points that need to be configured on the host machine, to ensure data persistence. There are suggested bind mounts that the end-user can change to fit their needs or they can setup additional volumes or disks to match the suggestions.</p><ul><li>In the <code>fedora</code> services section<ul><li><code>- /mnt/data/fedora/datastreamStore:/usr/local/fedora/data/datastreamStore</code></li><li><code>- /opt/data/fedora/objectStore:/usr/local/fedora/data/objectStore</code></li></ul></li><li>In the <code>apache</code> services section<ul><li><code>- /opt/data/apache/html:/var/www/html</code></li></ul></li></ul></li><li><p>Review the your <code>docker-compose.local.yml</code> file for custom edits made and copy them to the <code>docker-compose.production.yml</code> file as needed, this can include changes to Fedora GSearch Transforms, Fedora hash size and more.</p></li></ul><h3 id=ssl-certificates>SSL Certificates</h3><ul><li><p>Depending on your choice of SSL type (Commercial SSL files or the Let&rsquo;s Encrypt service), you&rsquo;ll need to uncomment only one line of the <code>traefik</code> services section. There are also inline instructions to this effect in the <code>docker-compose.production.yml</code> file.</p><ul><li><p>To use <code>Let's Encrypt for SSL</code>, uncomment:</p><ul><li><code>- ./config/proxy/acme.json:/acme.json</code></li></ul></li><li><p>To use commercial SSLs, uncomment:</p><ul><li><code>./config/proxy/ssl-certs:/certs:ro</code></li><li>Additionally you&rsquo;ll need to add your SSL certs (.cert, .pem, .key) files to <code>config/proxy/ssl-certs</code></li></ul></li></ul></li><li><p>Based on the choice of SSL type made above, you&rsquo;ll need to refer to the <code>/config/proxy/traefik.production.toml</code> file for further configuration instructions.</p></li></ul><hr><h2 id=step-4a-on-local---optional-changes-for-docker-composeproductionyml>Step 4A: On Local - (Optional) Changes for &ldquo;docker-compose.production.yml&rdquo;</h2><div class=annotation><p>I found this step to be <strong>UNECESSARY</strong> since my <code>dg-isle</code> and <code>dg-islandora</code> repositories have already been prepared.</p></div><p>This section is for optional changes for the <code>docker-compose.production.yml</code>, end-users do not have feel like they have to make any choices here and can continue to <strong>Step 4</strong> as needed.</p><p>The options include PHP settings, Java Memory Allocation, MySQL configuration and use of the <a href=../optional-components/tickstack.md>TICK Stack</a></p><ul><li><p><em>(Optional)</em> - You can change PHP settings such as file upload limits and memory usage by uncommenting the following in the <code>apache</code> services section.</p><ul><li><code>- ./config/apache/php_ini/php.production.ini:/etc/php/7.1/apache2/php.ini</code></li><li>You&rsquo;ll then need to make edits in the <code>./config/apache/php_ini/php.production.ini</code> file.</li></ul></li><li><p><em>(Optional)</em> - This line is already uncommented by default in ISLE but we&rsquo;re calling it out here that you can changes to the suggested levels or values within the <code>./config/mysql/ISLE.cnf</code> file if needed. When setting up for the first time, it is best practice to leave these settings in place. Over time, you can experiment with further tuning and experimentation based on your project or system needs.</p></li><li><p><em>(Optional)</em> - You can change the suggested <code>JAVA_MAX_MEM</code> & <code>JAVA_MIN_MEM</code> levels but do not exceed more than 50% of your system memory. When setting up for the first time, it is best practice to leave these settings in place as they are configured for a Production ISLE Host Server using 16 GB of RAM. Over time, you can experiment with further tuning and experimentation based on your project or system needs.</p></li><li><p><em>(Optional)</em> - You can opt to uncomment the TICK stack settings for monitoring but you&rsquo;ll need to follow the <a href=../optional-components/tickstack.md>TICK Stack</a> instructions prior to committing changes to your ISLE git repository.</p><ul><li>All TICK related code can be found at the end of all ISLE services within the <code>docker-compose.production.yml</code> file.</li><li><strong>Example:</strong></li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  <span style=color:#75715e>## _(Optional)_: Uncomment lines below to run ISLE with the TICK monitoring system</span>
</span></span><span style=display:flex><span>  logging:
</span></span><span style=display:flex><span>    driver: syslog
</span></span><span style=display:flex><span>    options:
</span></span><span style=display:flex><span>      tag: <span style=color:#e6db74>&#34;{{.Name}}&#34;</span>
</span></span></code></pre></div><ul><li>Uncomment the lines found in the new TICK stack services section of the <code>docker-compose.production.yml</code> file for hosting of that monitoring service on the Production ISLE Host server.<ul><li>There are additional configurations to be made to files contained within <code>./config/tick</code> but you&rsquo;ll need to follow the <a href=../optional-components/tickstack.md>TICK Stack</a> instructions prior to committing changes to your ISLE git repository.</li></ul></li><li>Uncomment the TICK stack data volumes as well at the bottom of the file.</li></ul><hr><h2 id=step-5-on-local-production---if-using-commercial-ssls>Step 5: On Local Production - If Using Commercial SSLs</h2><div class=annotation><p>I found this step to be <strong>UNECESSARY</strong> since my <code>dg-isle</code> and <code>dg-islandora</code> repositories have already been prepared.</p></div><p>If you are going to use Let&rsquo;s Encrypt instead, you can skip this step and move onto the next one. There will be additional steps further in this document, to help you configure it.</p><p>If you have decided to use Commercial SSL certs supplied to you by your IT team or appropriate resource, please continue following this step.</p><ul><li><p>Add your Commercial SSL certificate and key files to the <code>./config/proxy/ssl-certs</code> directory</p><ul><li><strong>Example:</strong></li><li><code>./config/proxy/ssl-certs/yourprojectnamehere.domain.cert</code></li><li><code>./config/proxy/ssl-certs/yourprojectnamehere.domain.key</code></li></ul></li><li><p>Edit the <code>./config/proxy/traefik.production.toml</code> and follow the in-line instructions. Replace the .pem & .key with the name of your Production SSL certificate and associated key. Do note the positioning of the added lines. Third character indentation.</p></li></ul><p><strong>Note:</strong> despite the instruction examples differing on file type, (<code>.pem</code> or <code>cert</code>), either one is compatible, use what you have been given. Merely change the file type suffix accordingly.</p><p><strong>Example: .cert</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    <span style=color:#f92672>[</span>entryPoints.https.tls<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>[[</span>entryPoints.https.tls.certificates<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>      certFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/certs/yourprojectnamehere.domain.cert&#34;</span>
</span></span><span style=display:flex><span>      keyFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/certs/yourprojectnamehere.domain.key&#34;</span>
</span></span></code></pre></div><p><strong>Example: .pem</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>    <span style=color:#f92672>[</span>entryPoints.https.tls<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>[[</span>entryPoints.https.tls.certificates<span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>      certFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/certs/yourprojectnamehere.institution.edu.pem&#34;</span>
</span></span><span style=display:flex><span>      keyFile <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/certs/yourprojectnamehere.institution.edu.key&#34;</span>
</span></span></code></pre></div><hr><h2 id=step-6-on-local---commit-isle-code-to-git-repository>Step 6: On Local - Commit ISLE Code to Git Repository</h2><div class=annotation><p>I found this step to be <strong>UNECESSARY</strong> since my <code>dg-isle</code> and <code>dg-islandora</code> repositories have already been prepared.</p></div><ul><li>Once you have made all of the appropriate changes to your Production profile. Please note the steps below are suggestions. You might use a different git commit message. Substitute <code>&lt;changedfileshere></code> with the actual file names and paths. You may need to do this repeatedly prior to the commit message.<ul><li><code>git add &lt;changedfileshere></code></li><li><code>git commit -m "Changes for Production"</code></li><li><code>git push origin master</code></li></ul></li></ul><hr><h2 id=on-remote-production---configure-the-isle-production-environment-profile-for-launch-and-usage>On Remote Production - Configure the ISLE Production Environment Profile for Launch and Usage</h2><h2 id=step-7-on-remote-production---git-clone-the-isle-repository-to-the-remote-production-isle-host-server>Step 7: On Remote Production - Git Clone the ISLE Repository to the Remote Production ISLE Host Server</h2><ul><li><p>This assumes you have setup an <code>Islandora</code> deploy user. If not use a different non-root user for this purpose.</p></li><li><p>You will also need to ensure that any <code>/home/islandora/.ssh/id_rsa.pub</code> key has been added to your git repository admin panel to allow for cloning from your two private git repositories.</p></li></ul><p>Since the <code>/opt</code> directory might not let you do this at first, we suggest the following workaround which you&rsquo;ll only need to do once. Future ISLE updates will not require this step.</p><ul><li><p>Shell into your Production ISLE host server as the <code>Islandora</code> user.</p></li><li><p>Clone your ISLE project repository with the newly committed changes for Production to the <code>Islandora</code> user home directory.</p><ul><li><code>git clone https://yourgitproviderhere.com/yourinstitutionhere/yourprojectnamehere-isle.git /home/islandora/</code></li><li>This may take a few minutes (2-4) depending on your server&rsquo;s Internet connection.</li></ul></li><li><p>Move the newly cloned directory to the <code>/opt</code> directory as the root user</p><ul><li><code>sudo mv /home/islandora/yourprojectnamehere-isle /opt/yourprojectnamehere-isle</code></li></ul></li><li><p>Fix the permissions so that the <code>islandora</code> user has access.</p><ul><li><code>sudo chown -Rv islandora:islandora /opt/yourprojectnamehere-isle</code></li></ul></li></ul><div class=annotation><p><strong>Important!</strong></p><p>The <code>/opt/ISLE</code> directory on <code>DGDocker1</code> is already configured to allow the <code>islandora</code> user to read, write, and execute, so I moved the existing copy of that directory, as well as the <code>production_data</code> directory, to <code>/opt/.out-of-the-way</code> and created a new <code>/opt/ISLE</code> directory owned by <code>islandora:islandora</code>. I will use <code>/opt/ISLE</code> as my project &ldquo;root&rdquo;, in place of <code>/opt</code>.</p><p>So, I did this&mldr;</p><pre tabindex=0><code>[islandora@dgdocker1 opt]$ cd /opt/ISLE
[islandora@dgdocker1 ISLE]$ git clone --recursive https://github.com/Digital-Grinnell/dg-isle
Cloning into &#39;dg-isle&#39;...
Username for &#39;https://github.com&#39;: digital@grinnell.edu
Password for &#39;https://digital@grinnell.edu@github.com&#39;:
remote: Enumerating objects: 5172, done.
remote: Counting objects: 100% (5172/5172), done.
remote: Compressing objects: 100% (1853/1853), done.
remote: Total 5172 (delta 3277), reused 5072 (delta 3183), pack-reused 0
Receiving objects: 100% (5172/5172), 7.25 MiB | 0 bytes/s, done.
Resolving deltas: 100% (3277/3277), done.
Submodule &#39;data/apache/html/sites/all/themes/bootstrap&#39; (https://github.com/drupalprojects/bootstrap.git) registered for path &#39;data/apache/html/sites/all/themes/bootstrap&#39;
Submodule &#39;data/apache/html/sites/all/themes/digital_grinnell_bootstrap&#39; (https://github.com/DigitalGrinnell/digital_grinnell_bootstrap.git) registered for path &#39;data/apache/html/sites/all/themes/digital_grinnell_bootstrap&#39;
Submodule &#39;data/apache/html/sites/default/themes/digital_grinnell_bootstrap&#39; (https://github.com/DigitalGrinnell/digital_grinnell_bootstrap.git) registered for path &#39;data/apache/html/sites/default/themes/digital_grinnell_bootstrap&#39;
Cloning into &#39;data/apache/html/sites/all/themes/bootstrap&#39;...
remote: Enumerating objects: 12635, done.
remote: Total 12635 (delta 0), reused 0 (delta 0), pack-reused 12635
Receiving objects: 100% (12635/12635), 2.83 MiB | 0 bytes/s, done.
Resolving deltas: 100% (9255/9255), done.
Submodule path &#39;data/apache/html/sites/all/themes/bootstrap&#39;: checked out &#39;c050d1d6ae85ef344be85dbf0a4ed9ec68ac32ce&#39;
Cloning into &#39;data/apache/html/sites/all/themes/digital_grinnell_bootstrap&#39;...
remote: Enumerating objects: 190, done.
remote: Total 190 (delta 0), reused 0 (delta 0), pack-reused 190
Receiving objects: 100% (190/190), 1.08 MiB | 0 bytes/s, done.
Resolving deltas: 100% (70/70), done.
Submodule path &#39;data/apache/html/sites/all/themes/digital_grinnell_bootstrap&#39;: checked out &#39;654a43649a5130fa998d549e4233f9736aa4cca6&#39;
Cloning into &#39;data/apache/html/sites/default/themes/digital_grinnell_bootstrap&#39;...
remote: Enumerating objects: 190, done.
remote: Total 190 (delta 0), reused 0 (delta 0), pack-reused 190
Receiving objects: 100% (190/190), 1.08 MiB | 0 bytes/s, done.
Resolving deltas: 100% (70/70), done.
Submodule path &#39;data/apache/html/sites/default/themes/digital_grinnell_bootstrap&#39;: checked out &#39;654a43649a5130fa998d549e4233f9736aa4cca6&#39;
</code></pre></div><hr><h2 id=step-8-on-remote-production---create-the-appropriate-local-data-paths-for-apache-fedora-and-log-data>Step 8: On Remote Production - Create the Appropriate Local Data Paths for Apache, Fedora and Log Data</h2><ul><li>Create the <code>/opt/data</code> directory<ul><li><code>sudo mkdir -p /opt/data</code></li></ul></li><li>Change the permissions to the Islandora user.<ul><li><code>sudo chown -Rv islandora:islandora /opt/data</code></li></ul></li></ul><div class=annotation><p>To adjust for my project root at <code>/opt/ISLE</code>, I did this instead:</p><pre tabindex=0><code>sudo mkdir -p /opt/ISLE/data
sudo chown -Rv islandora:islandora /opt/ISLE/data
</code></pre></div><hr><h2 id=step-9-on-remote-production---clone-your-production-islandora-code>Step 9: On Remote Production - Clone Your Production Islandora Code</h2><p>Please clone from your existing Production Islandora git repository.</p><ul><li><p><code>git clone git@yourgitproviderhere.com/yourinstitutionhere/yourprojectnamehere-islandora.git /opt/data/apache/html</code></p></li><li><p>Fix the permissions so that the <code>islandora</code> user has access.</p><ul><li><code>sudo chown -Rv islandora:islandora /opt/yourprojectnamehere-islandora</code></li></ul></li></ul><div class=annotation><p>Again, to adjust for my project root, I did this:</p><pre tabindex=0><code>[islandora@dgdocker1 ~]$ git clone --recursive https://github.com/Digital-Grinnell/dg-islandora /opt/ISLE/data/apache/html
Cloning into &#39;/opt/ISLE/data/apache/html&#39;...
Username for &#39;https://github.com&#39;: digital@grinnell.edu
Password for &#39;https://digital@grinnell.edu@github.com&#39;:
remote: Enumerating objects: 646, done.
remote: Counting objects: 100% (646/646), done.
remote: Compressing objects: 100% (592/592), done.
remote: Total 10452 (delta 118), reused 243 (delta 45), pack-reused 9806
Receiving objects: 100% (10452/10452), 63.00 MiB | 40.34 MiB/s, done.
Resolving deltas: 100% (2212/2212), done.
Submodule &#39;sites/all/libraries/glip&#39; (https://github.com/halstead/glip) registered for path &#39;sites/all/libraries/glip&#39;
Submodule &#39;sites/all/modules/islandora/dg7&#39; (https://github.com/DigitalGrinnell/dg7) registered for path &#39;sites/all/modules/islandora/dg7&#39;
Submodule &#39;sites/all/modules/islandora/idu&#39; (https://github.com/DigitalGrinnell/idu) registered for path &#39;sites/all/modules/islandora/idu&#39;
Submodule &#39;sites/all/modules/islandora/islandora_binary_object&#39; (https://github.com/Islandora-Labs/islandora_binary_object) registered for path &#39;sites/all/modules/islandora/islandora_binary_object&#39;
Submodule &#39;sites/all/modules/islandora/islandora_collection_search&#39; (https://github.com/discoverygarden/islandora_collection_search) registered for path &#39;sites/all/modules/islandora/islandora_collection_search&#39;
Submodule &#39;sites/all/modules/islandora/islandora_datastream_exporter&#39; (https://github.com/Islandora-Labs/islandora_datastream_exporter.git) registered for path &#39;sites/all/modules/islandora/islandora_datastream_exporter&#39;
Submodule &#39;sites/all/modules/islandora/islandora_datastream_replace&#39; (https://github.com/DigitalGrinnell/islandora_datastream_replace.git) registered for path &#39;sites/all/modules/islandora/islandora_datastream_replace&#39;
Submodule &#39;sites/all/modules/islandora/islandora_mods_display&#39; (https://github.com/DigitalGrinnell/islandora_mods_display.git) registered for path &#39;sites/all/modules/islandora/islandora_mods_display&#39;
Submodule &#39;sites/all/modules/islandora/islandora_mods_via_twig&#39; (https://github.com/DigitalGrinnell/islandora_mods_via_twig.git) registered for path &#39;sites/all/modules/islandora/islandora_mods_via_twig&#39;
Submodule &#39;sites/all/modules/islandora/islandora_multi_importer&#39; (https://github.com/DigitalGrinnell/islandora_multi_importer) registered for path &#39;sites/all/modules/islandora/islandora_multi_importer&#39;
Submodule &#39;sites/all/modules/islandora/islandora_solr_collection_view&#39; (https://github.com/Islandora-Labs/islandora_solr_collection_view.git) registered for path &#39;sites/all/modules/islandora/islandora_solr_collection_view&#39;
Submodule &#39;sites/all/modules/islandora/islandora_solr_views&#39; (https://github.com/DigitalGrinnell/islandora_solr_views) registered for path &#39;sites/all/modules/islandora/islandora_solr_views&#39;
Submodule &#39;sites/all/modules/islandora/islandora_solution_pack_oralhistories&#39; (https://github.com/Islandora-Labs/islandora_solution_pack_oralhistories.git) registered for path &#39;sites/all/modules/islandora/islandora_solution_pack_oralhistories&#39;
Submodule &#39;sites/all/themes/bootstrap&#39; (https://github.com/drupalprojects/bootstrap.git) registered for path &#39;sites/all/themes/bootstrap&#39;
Submodule &#39;sites/default/themes/digital_grinnell_bootstrap&#39; (https://github.com/DigitalGrinnell/digital_grinnell_bootstrap.git) registered for path &#39;sites/default/themes/digital_grinnell_bootstrap&#39;
Cloning into &#39;sites/all/libraries/glip&#39;...
remote: Enumerating objects: 319, done.
remote: Total 319 (delta 0), reused 0 (delta 0), pack-reused 319
Receiving objects: 100% (319/319), 101.97 KiB | 0 bytes/s, done.
Resolving deltas: 100% (163/163), done.
Submodule path &#39;sites/all/libraries/glip&#39;: checked out &#39;79f5472af4b9261d20f51e92f07d4cca01e83a2c&#39;
Cloning into &#39;sites/all/modules/islandora/dg7&#39;...
remote: Enumerating objects: 335, done.
remote: Total 335 (delta 0), reused 0 (delta 0), pack-reused 335
Receiving objects: 100% (335/335), 201.05 KiB | 0 bytes/s, done.
Resolving deltas: 100% (203/203), done.
Submodule path &#39;sites/all/modules/islandora/dg7&#39;: checked out &#39;f6cca12904d24c57fcc408b93db92893a564e231&#39;
Cloning into &#39;sites/all/modules/islandora/idu&#39;...
remote: Enumerating objects: 21, done.
remote: Counting objects: 100% (21/21), done.
remote: Compressing objects: 100% (15/15), done.
remote: Total 64 (delta 10), reused 16 (delta 6), pack-reused 43
Unpacking objects: 100% (64/64), done.
Submodule path &#39;sites/all/modules/islandora/idu&#39;: checked out &#39;0d91bd6e563f2955563649fc9168c4e8e518f45c&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_binary_object&#39;...
remote: Enumerating objects: 353, done.
remote: Total 353 (delta 0), reused 0 (delta 0), pack-reused 353
Receiving objects: 100% (353/353), 80.16 KiB | 0 bytes/s, done.
Resolving deltas: 100% (187/187), done.
Submodule path &#39;sites/all/modules/islandora/islandora_binary_object&#39;: checked out &#39;53b67d57cf1ca8052910a90006ad0af183a23389&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_collection_search&#39;...
remote: Enumerating objects: 438, done.
remote: Total 438 (delta 0), reused 0 (delta 0), pack-reused 438
Receiving objects: 100% (438/438), 83.91 KiB | 0 bytes/s, done.
Resolving deltas: 100% (209/209), done.
Submodule path &#39;sites/all/modules/islandora/islandora_collection_search&#39;: checked out &#39;69545bed8d953d71344fee44de39074d88da0f90&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_datastream_exporter&#39;...
remote: Enumerating objects: 80, done.
remote: Total 80 (delta 0), reused 0 (delta 0), pack-reused 80
Unpacking objects: 100% (80/80), done.
Submodule path &#39;sites/all/modules/islandora/islandora_datastream_exporter&#39;: checked out &#39;b1be7e77fd9f14b72dd1a78130109ce0d9a51fd3&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_datastream_replace&#39;...
remote: Enumerating objects: 6, done.
remote: Counting objects: 100% (6/6), done.
remote: Compressing objects: 100% (4/4), done.
remote: Total 84 (delta 2), reused 6 (delta 2), pack-reused 78
Unpacking objects: 100% (84/84), done.
Submodule path &#39;sites/all/modules/islandora/islandora_datastream_replace&#39;: checked out &#39;0e786886d8da2ebc30a89d23654710aaa180cceb&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_mods_display&#39;...
remote: Enumerating objects: 128, done.
remote: Counting objects: 100% (128/128), done.
remote: Compressing objects: 100% (80/80), done.
remote: Total 271 (delta 91), reused 85 (delta 48), pack-reused 143
Receiving objects: 100% (271/271), 282.28 KiB | 0 bytes/s, done.
Resolving deltas: 100% (182/182), done.
Submodule path &#39;sites/all/modules/islandora/islandora_mods_display&#39;: checked out &#39;08249e5a0486c28c698acb7d11db24af5c6ec63c&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_mods_via_twig&#39;...
remote: Enumerating objects: 197, done.
remote: Counting objects: 100% (197/197), done.
remote: Compressing objects: 100% (137/137), done.
remote: Total 197 (delta 126), reused 127 (delta 60), pack-reused 0
Receiving objects: 100% (197/197), 44.94 KiB | 0 bytes/s, done.
Resolving deltas: 100% (126/126), done.
Submodule path &#39;sites/all/modules/islandora/islandora_mods_via_twig&#39;: checked out &#39;5cc26c14bd35ce1131f246e3b36657d06be0b126&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_multi_importer&#39;...
remote: Enumerating objects: 978, done.
remote: Total 978 (delta 0), reused 0 (delta 0), pack-reused 978
Receiving objects: 100% (978/978), 643.47 KiB | 0 bytes/s, done.
Resolving deltas: 100% (681/681), done.
Submodule path &#39;sites/all/modules/islandora/islandora_multi_importer&#39;: checked out &#39;78c06b719287a3c0250e902552ec05f760780b9b&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_solr_collection_view&#39;...
remote: Enumerating objects: 134, done.
remote: Total 134 (delta 0), reused 0 (delta 0), pack-reused 134
Receiving objects: 100% (134/134), 31.88 KiB | 0 bytes/s, done.
Resolving deltas: 100% (72/72), done.
Submodule path &#39;sites/all/modules/islandora/islandora_solr_collection_view&#39;: checked out &#39;c4b2f33251e3f46bb3bc4789480a60a8efe5d351&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_solr_views&#39;...
remote: Enumerating objects: 615, done.
remote: Total 615 (delta 0), reused 0 (delta 0), pack-reused 615
Receiving objects: 100% (615/615), 174.41 KiB | 0 bytes/s, done.
Resolving deltas: 100% (354/354), done.
Submodule path &#39;sites/all/modules/islandora/islandora_solr_views&#39;: checked out &#39;3c17f497a51bc7f5bf90a6bd38e02733b79dca94&#39;
Cloning into &#39;sites/all/modules/islandora/islandora_solution_pack_oralhistories&#39;...
remote: Enumerating objects: 11, done.
remote: Counting objects: 100% (11/11), done.
remote: Compressing objects: 100% (11/11), done.
remote: Total 3434 (delta 3), reused 2 (delta 0), pack-reused 3423
Receiving objects: 100% (3434/3434), 11.20 MiB | 0 bytes/s, done.
Resolving deltas: 100% (1392/1392), done.
Submodule path &#39;sites/all/modules/islandora/islandora_solution_pack_oralhistories&#39;: checked out &#39;60b84295deb4c7b11fbe5c172e3f815eb78cd942&#39;
Cloning into &#39;sites/all/themes/bootstrap&#39;...
remote: Enumerating objects: 12635, done.
remote: Total 12635 (delta 0), reused 0 (delta 0), pack-reused 12635
Receiving objects: 100% (12635/12635), 2.83 MiB | 0 bytes/s, done.
Resolving deltas: 100% (9255/9255), done.
Submodule path &#39;sites/all/themes/bootstrap&#39;: checked out &#39;c050d1d6ae85ef344be85dbf0a4ed9ec68ac32ce&#39;
Cloning into &#39;sites/default/themes/digital_grinnell_bootstrap&#39;...
remote: Enumerating objects: 190, done.
remote: Total 190 (delta 0), reused 0 (delta 0), pack-reused 190
Receiving objects: 100% (190/190), 1.08 MiB | 0 bytes/s, done.
Resolving deltas: 100% (70/70), done.
Submodule path &#39;sites/default/themes/digital_grinnell_bootstrap&#39;: checked out &#39;22b51ecfb61c7e348e25892e988bcf82d0b1c781&#39;
</code></pre></div><hr><h2 id=step-10-on-remote-production---copy-over-the-production-data-directories>Step 10: On Remote Production - Copy Over the Production Data Directories</h2><ul><li><p>It is recommended that you schedule a content freeze for all Production Fedora ingests and additions to your Production website. This will allow you to get up to date data from Production to Production.</p></li><li><p>As you may have made some critical decisions potentially from &ldquo;Step 0: Copy Production Data to Your Local&rdquo; of the <a href=../install/install-local-migrate.md>Local ISLE Installation: Migrate Existing Islandora Site</a> instructions, you need to re-follow the steps to get your:</p><ul><li>Production Drupal site <code>files</code> directory</li><li><code>Solr schema & Islandora transforms</code><ul><li>If you picked <strong>Easy</strong> option:<ul><li>then you don&rsquo;t need to do anything here for the <code>Solr schema & Islandora transforms</code></li></ul></li><li>If you picked the <strong>Intermediate</strong> or <strong>Advanced</strong> options:<ul><li>You&rsquo;ll need to copy in the customizations and files you created during the <code>local</code> environment into the <code>docker-compose.production.yml</code>. Ensure that one set of transforms and schema are used across all environments.</li></ul></li></ul></li><li>Production Fedora <code>datastreamStore</code> directory<ul><li>You&rsquo;ll need to adjust the paths below in case your setup differs on either the non-ISLE Production server or the ISLE Production server.</li><li>Copy your <code>/usr/local/fedora/data/datastreamStore</code> data to the suggested path of <code>/mnt/data/fedora/datastreamStore</code><ul><li>You may need to change the permissions to <code>root:root</code> on the Production <code>/mnt/data/fedora/datastreamStore</code> directory above after copying so the Fedora container can access properly. Do not do this on your existing Production system please.</li></ul></li></ul></li><li>Production Fedora <code>objectStore</code>.<ul><li>Copy your <code>/usr/local/fedora/data/objectStore</code> data to the suggested path of <code>/opt/data/fedora/objectStore</code><ul><li>You may need to change the permissions to <code>root:root</code> on the Production <code>/opt/data/fedora/objectStore</code> above after copying so the Fedora container can access properly. Do not do this on your existing Production system please.</li></ul></li></ul></li></ul></li></ul><div class=annotation><p>All I did for this step was:</p><pre tabindex=0><code>[islandora@dgdocker1 ~]$ mkdir -p /opt/ISLE/data/apache/html/sites/default/files
[islandora@dgdocker1 ~]$ cp -fr ~/DG-PROD/data/files/. /opt/ISLE/data/apache/html/sites/default/files/.
[islandora@dgdocker1 ~]$ chown -R islandora:islandora /opt/ISLE/data/apache
</code></pre></div><hr><h2 id=step-11-on-remote-production---if-using-lets-encrypt>Step 11: On Remote Production - If Using Let&rsquo;s Encrypt</h2><p>If you are using Commercial SSLs, then please stop and move onto the next step.</p><p>If using Let&rsquo;s Encrypt, please continue to follow this step.</p><ul><li>Create an empty <code>acme.json</code> within the <code>./config/proxy/ssl-certs/</code> directory of your ISLE project.<ul><li><code>touch /opt/yourprojectnamehere/config/proxy/ssl-certs/acme.json</code></li><li><code>chmod 600 /opt/yourprojectnamehere/config/proxy/ssl-certs/acme.json</code></li><li>This file will be ignored by git and won&rsquo;t cause any errors with checking in code despite the location</li><li>Do note that you may need to open your firewall briefly to allow the SSL certs to be added to the <code>acme.json</code> file. This will be indicated in the following steps.</li><li>Open your firewall to ports 80, 443 prior to starting up the containers to ensure SSL cert creation.</li></ul></li></ul><div class=annotation><p>My IT department will NOT permit me to open port 443, not even for an instant, so I have to handle our existing <code>acme.json</code> file differently. I&rsquo;m using a backup copy of <code>acme.json</code>, like so:</p><pre tabindex=0><code>[islandora@dgdocker1 proxy]$ cp -f /home/islandora/DG-PROD/data/config/proxy/acme.json /opt/ISLE/dg-isle/config/proxy/acme.json
[islandora@dgdocker1 proxy]$ chmod 400 /opt/ISLE/dg-isle/config/proxy/acme.json
</code></pre></div><hr><h2 id=step-12-on-remote-production---edit-the-env-file-to-change-to-the-production-environment>Step 12: On Remote Production - Edit the &ldquo;.env&rdquo; File to Change to the Production Environment</h2><p>This step is a multi-step, involved process that allows an end-user to make appropriate changes to the <code>.env</code> and then commit it locally to git. This local commit that never gets pushed back to the git repository is critical to allow future ISLE updates or config changes.</p><ul><li><p>Copy the sample.env to .env. By default, the Demo environment is setup. You will need to edit this file to match the correct environment. Please note that the .env is no longer tracked by git as of ISLE version 1.5. Instructions below involving git are for ISLE versions below 1.5. However the settings recommended below for the environment can still be followed as needed.</p><ul><li><code>cp sample.env .env</code></li></ul></li><li><p>Edit the .env, remove the <code>local</code> settings and then commit locally (only if using an ISLE version below 1.5)</p><ul><li><code>cd /opt/yourprojectnamehere</code></li><li><code>vi / nano / pico /opt/yourprojectnamehere/.env</code></li><li>Edit <code>COMPOSE_PROJECT_NAME=</code> and replace the <code>local</code> settings with:<ul><li><code>COMPOSE_PROJECT_NAME=</code> (Suggested) Add an identifiable project or institutional name plus environment e.g. acme_digital_production`</li></ul></li><li>Edit <code>BASE_DOMAIN=</code> and replace the <code>local</code> settings with:<ul><li><code>BASE_DOMAIN=</code> (Suggested) Add the full production domain here e.g. digital.institution.edu</li></ul></li><li>Edit <code>CONTAINER_SHORT_ID=</code> and replace the <code>local</code> settings with:<ul><li><code>CONTAINER_SHORT_ID=</code> (Suggested) Make an easy to read acronym from the letters of your institution and collection names plus environment e.g. (acme digitalcollections production) is acdcp</li></ul></li><li>Edit <code>COMPOSE_FILE</code> change <code>local</code> to <code>production</code><ul><li><code>COMPOSE_FILE=docker-compose.production.yml</code></li></ul></li><li>Save the file</li></ul></li><li><p>For users of ISLE version 1.5 and above, these git instructions below are not needed. The .env file is no longer tracked in git.</p></li><li><p>For users of ISLE versions 1.4.2 and below, you will need to continue to follow these instructions until you upgrade.</p><ul><li>Enter <code>git status</code> - You&rsquo;ll now see the following:</li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>On branch master
</span></span><span style=display:flex><span>Your branch is up to date with <span style=color:#e6db74>&#39;origin/master&#39;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Changes not staged <span style=color:#66d9ef>for</span> commit:
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span>use <span style=color:#e6db74>&#34;git add &lt;file&gt;...&#34;</span> to update what will be committed<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>(</span>use <span style=color:#e6db74>&#34;git checkout -- &lt;file&gt;...&#34;</span> to discard changes in working directory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	modified:   .env
</span></span></code></pre></div><ul><li><p>You&rsquo;ll need to add this file and commit it in git to be able to get future updates from ISLE as a process.</p><ul><li><code>git add .env</code></li><li><code>git commit -m "Added the edited .env configuration file for Production. DO NOT PUSH BACK TO UPSTREAM REPOSITORY - Jane Doe 8/2019"</code><ul><li>This is a suggested warning for users <strong>NOT TO</strong> push back this configuration change to the main git repository. If that were done it could conflict with other setups.</li></ul></li></ul></li><li><p>You may run into the following:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>*** Please tell me who you are.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  git config --global user.email <span style=color:#e6db74>&#34;you@example.com&#34;</span>
</span></span><span style=display:flex><span>  git config --global user.name <span style=color:#e6db74>&#34;Your Name&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>to set your account<span style=color:#960050;background-color:#1e0010>&#39;</span>s default identity.
</span></span><span style=display:flex><span>Omit --global to set the identity only in this repository.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fatal: empty ident name <span style=color:#f92672>(</span><span style=color:#66d9ef>for</span> &lt;islandora@yourprojectnamehere.institution.edu&gt;<span style=color:#f92672>)</span> not allowed
</span></span></code></pre></div><ul><li><p>Configure your server git client but don&rsquo;t use the <code>--global</code> setting as that could interfere with other git repositories e.g. your Islandora Drupal code.</p><ul><li><strong>Example:</strong> Within <code>/opt/yourprojectnamehere</code></li><li><code>git config user.email "jane@institution.edu"</code></li><li><code>git config user.name "Jane Doe"</code></li></ul></li><li><p>Now re-run the commit command:</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;Added the edited .env configuration file for Production. DO NOT PUSH BACK TO UPSTREAM REPOSITORY - Jane Doe 8/2019&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>master 7ab3fcf9<span style=color:#f92672>]</span> Added the edited .env configuration file <span style=color:#66d9ef>for</span> Production. DO NOT PUSH BACK TO UPSTREAM REPOSITORY - Jane Doe 8/2019
</span></span><span style=display:flex><span> <span style=color:#ae81ff>1</span> file changed, <span style=color:#ae81ff>4</span> insertions<span style=color:#f92672>(</span>+<span style=color:#f92672>)</span>, <span style=color:#ae81ff>4</span> deletions<span style=color:#f92672>(</span>-<span style=color:#f92672>)</span>
</span></span></code></pre></div><div class=annotation><p>In this section I chose to simply copy <code>sample.env</code> to <code>.env</code>, and edit using <em>nano</em> to come up with this <code>.env</code> file:</p><pre tabindex=0><code>#### Activated ISLE environment
# To use an environment other than the default Demo, please change values below
# from the default Demo to one of the following: Local, Test, Staging or Production
# For more information, consult https://islandora-collaboration-group.github.io/ISLE/install/install-environments/

COMPOSE_PROJECT_NAME=dg
BASE_DOMAIN=digital.grinnell.edu
CONTAINER_SHORT_ID=dg
COMPOSE_FILE=docker-compose.production.yml
</code></pre></div><hr><h2 id=step-13-on-remote-production---download-the-isle-images>Step 13: On Remote Production - Download the ISLE Images</h2><ul><li>Download all of the latest ISLE Docker images (<em>~6 GB of data may take 5-10 minutes</em>).</li><li><em>Using the same open terminal:</em><ul><li>Navigate to the root of your ISLE project</li><li><code>cd ~/opt/yourprojectnamehere</code></li><li><code>docker-compose pull</code></li></ul></li></ul><div class=annotation><p>In my case:</p><pre tabindex=0><code>cd /opt/ISLE/dg-isle
docker-compose pull
</code></pre></div><hr><h2 id=step-14-on-remote-production---start-containers>Step 14: On Remote Production - Start Containers</h2><p><strong>Note:</strong> Prior to starting the launch process, it is recommended that you briefly open your firewall to allow ports 80 and 443 access to the world. You&rsquo;ll only need to keep this open for 3 -5 minutes and then promptly close access once the Let&rsquo;s Encrypt SSL certificates have been generated.</p><ul><li><p><em>Using the same open terminal:</em></p><ul><li><code>docker-compose up -d</code></li></ul></li><li><p>Please wait a few moments for the stack to fully come up. Approximately 3-5 minutes.</p></li><li><p><em>Using the same open terminal:</em></p><ul><li>View only the running containers: <code>docker ps</code></li><li>View all containers (both those running and stopped): <code>docker ps -a</code></li><li>All containers prefixed with <code>isle-</code> are expected to have a <code>STATUS</code> of <code>Up</code> (for x time).<ul><li><strong>If any of these are not <code>UP</code>, then use <a href=install-troubleshooting.md>ISLE Installations: Troubleshooting</a> to solve before continuing below.</strong>
&lt;!- TODO: This could be confusing if (a) there are other, non-ISLE containers, or (b) the isle-varnish container is installed but intentionally not running, or (c) older exited ISLE containers that maybe should be removed. -></li></ul></li></ul></li><li><p>In your web browser, enter your Production site URL: <code>https://yourprojectnamehere.institution.edu</code></p><ul><li><strong>Note:</strong> You should not see any errors with respect to the SSL certifications, you should see a nice green lock padlock for the site security. If you see a red error or unknown SSL cert provider, you&rsquo;ll need to shut the containers down and review the previous steps taken especially if using Let&rsquo;s Encrypt. You may need to repeat those steps to get rid of the errors.</li></ul></li></ul><div class=annotation><p>In my case, there are still containers from the old stack that have been stopped, but are still hanging around. Those need to be deleted before this can proceed. So:</p><pre tabindex=0><code>cd /opt/ISLE/dg-isle
./destroy.sh
docker-compose up -d
</code></pre><p>Note the <code>destroy.sh</code> script contains:</p><pre tabindex=0><code>#!/bin/bash
#
docker stop $(docker ps -q);
docker rm -v $(docker ps -qa);
docker image rm $(docker image ls -q)
docker system prune --force
</code></pre></div><hr><h2 id=step-15-on-remote-production---import-the-local-mysql-drupal-database>Step 15: On Remote Production - Import the Local MySQL Drupal Database</h2><p><strong>Prior to attempting this step, please consider the following:</strong></p><ul><li><p>If the end user is running multi-sites, there will be additional databases to export.</p></li><li><p>Do not import the <code>fedora3</code> database</p></li></ul><hr><h3 id=import-the-local-mysql-islandora-drupal-database>Import the Local MySQL Islandora Drupal Database</h3><ul><li><p>Copy the <code>local_drupal_site_082019.sql</code> created in Step 1 to the Remote Production server.</p></li><li><p>Import the exported Local MySQL database for use in the current Production Drupal site. Refer to your <code>production.env</code> for the usernames and passwords used below.</p><ul><li>You can use a MySQL GUI client for this process instead but the command line directions are only included below.</li><li>Run <code>docker ps</code> to determine the MySQL container name</li><li><em>Using the same open terminal:</em></li><li>Shell into your currently running Production MySQL container<ul><li><code>docker exec -it your-mysql-containername bash</code></li></ul></li><li>Import the Local Islandora Drupal database. Replace the &ldquo;DRUPAL_DB_USER&rdquo; and &ldquo;DRUPAL_DB&rdquo; in the command below with the values found in your &ldquo;production.env&rdquo; file.<ul><li><code>mysql -u DRUPAL_DB_USER -p DRUPAL_DB &lt; local_drupal_site_082019.sql</code></li><li>Enter the appropriate password: value of <code>DRUPAL_DB_PASS</code> in the &ldquo;production.env&rdquo;)</li><li>This might take a few minutes depending on the size of the file.</li><li>Type <code>exit</code> to exit the container</li></ul></li></ul></li></ul><div class=annotation><p>Ok, so my &ldquo;staging&rdquo; database is in much better shape than production at this point, so my process was:</p><pre tabindex=0><code>[islandora@dgdocker1 dg-isle]$ docker cp ~/DG-PROD/data/staging_drupal_site_112220.sql isle-mysql-dg:staging.sql
[islandora@dgdocker1 dg-isle]$ docker exec -it isle-mysql-dg bash
root@95d316d986a9:/# mysql -u admin -p digital_grinnell &lt; staging.sql
Enter password:
root@95d316d986a9:/# exit
</code></pre><p>Also, my configuration requires that I run <code>composer update</code> for the IMI module, so:</p><pre tabindex=0><code>[islandora@dgdocker1 dg-isle]$ docker exec -w /var/www/html/sites/all/modules/islandora/islandora_multi_importer/ isle-apache-dg composer update
...output removed for clarity...
[islandora@dgdocker1 dg-isle]$ docker exec -w /var/www/html/sites/default isle-apache-dg drush cc all
&#39;all&#39; cache was cleared.
</code></pre><p>Once these steps were complete <a href=https://digital.grinnell.edu>https://digital.grinnell.edu</a> will open, but displays no objects. Next up, I need to rebuild the FEDORA resource and Solr indicies.</p></div><hr><h2 id=step-16-on-remote-production---run-isle-scripts>Step 16: On Remote Production - Run ISLE Scripts</h2><div class=annotation><p>I found this step to be <strong>UNECESSARY</strong> since my <code>dg-isle</code> and <code>dg-islandora</code> repositories have already been prepared.</p></div><p>This step will show you how to run the &ldquo;migration_site_vsets.sh&rdquo; script on the Apache container to change Drupal database site settings for ISLE connectivity.</p><p><em>Using the same open terminal:</em></p><ul><li>Run <code>docker ps</code> to determine the apache container name</li><li>Copy the &ldquo;migration_site_vsets.sh&rdquo; to the root of the Drupal directory on your Apache container<ul><li><code>docker cp ./scripts/apache/migration_site_vsets.sh your-apache-containername:/var/www/html/migration_site_vsets.sh</code></li></ul></li><li>Change the permissions on the script to make it executable<ul><li><code>docker exec -it your-apache-containername bash -c "chmod +x /var/www/html/migration_site_vsets.sh"</code></li></ul></li><li>Run the script<ul><li><code>docker exec -it your-apache-containername bash -c "cd /var/www/html && ./migration_site_vsets.sh"</code></li></ul></li></ul><p>This step will show you how to shell into your currently running Production Apache container, and run the &ldquo;fix-permissions.sh&rdquo; script to fix the Drupal site permissions.</p><ul><li><code>docker exec -it your-apache-containername bash</code></li><li><code>sh /utility-scripts/isle_drupal_build_tools/drupal/fix-permissions.sh --drupal_path=/var/www/html --drupal_user=islandora --httpd_group=www-data</code></li><li>This process will take 2-5 minutes</li><li>You should see a lot of green [ok] messages.</li><li>If the script appears to pause or prompt for <code>y/n</code>, DO NOT enter any values; the script will automatically answer for you.</li><li>Type <code>exit</code> to exit the container</li></ul><table><thead><tr><th style=text-align:left>For Microsoft Windows:</th></tr></thead><tbody><tr><td style=text-align:left>You may be prompted by Windows to:</td></tr><tr><td style=text-align:left>- Share the C drive with Docker. Click Okay or Allow.</td></tr><tr><td style=text-align:left>- Enter your username and password. Do this.</td></tr><tr><td style=text-align:left>- Allow vpnkit.exe to communicate with the network. Click Okay or Allow (accept default selection).</td></tr><tr><td style=text-align:left>- If the process seems to halt, check the taskbar for background windows.</td></tr></tbody></table><hr><h2 id=step-17-on-remote-production---re-index-fedora--solr>Step 17: On Remote Production - Re-Index Fedora & Solr</h2><p>When migrating any non-ISLE Islandora site, it is crucial to rebuild (reindex) the following three indices from the FOXML and datastream files on disk.</p><ul><li><p><strong>Fedora&rsquo;s indices:</strong></p><ul><li>Resource Index - The Resource Index is the Fedora module that provides the infrastructure for indexing relationships among objects and their components.</li><li>SQL database - <code>fedora3</code> contains information vital for the Drupal site to connect to Fedora correctly.</li></ul></li><li><p><strong>Solr index</strong> - Solr an open source enterprise search platform works in conjunction with the Islandora Solr module to provide a way to configure the Islandora search functions, the search results display, and the display of metadata on object pages. The index serves as a list of those objects for fast searching across large collections.</p></li></ul><p>You can use the command-line interactive utility <code>fedora-rebuild.sh</code> on the <code>fedora</code> container to rebuild all indices when the Fedora (not Tomcat) server is offline.</p><p>Depending on the size of your repository, this entire process may take minutes (thousands of objects) or hours (millions of objects) to complete.</p><h3 id=reindex-fedora-ri--fedora-sql-database-23>Reindex Fedora RI & Fedora SQL Database (2/3)</h3><p>Since this command can take minutes or hours depending on the size of your repository, As such, it is recommended starting a screen session prior to running the following commands. Learn more about <a href=https://www.tecmint.com/screen-command-examples-to-manage-linux-terminals/>screen here</a></p><p><strong>Note:</strong> The method described below is a longer way of doing this process to onboard users.</p><ul><li><p>Shell into your currently running Production Fedora container</p></li><li><p>Run <code>docker ps</code> to determine the Fedora container name</p><ul><li><code>docker exec -it your-fedora-containername bash</code></li></ul></li><li><p>Navigate to the <code>utility_scripts</code> directory</p><ul><li><code>cd utility_scripts</code></li></ul></li><li><p>Run the <code>rebuildFedora.sh</code> script. This script will give you output like the example below.</p><ul><li><code>./rebuildFedora.sh</code></li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>  OK - Stopped application at context path <span style=color:#f92672>[</span>/fedora<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>Starting the rebuild process in the background. This may take a <span style=color:#66d9ef>while</span> depending on your Fedora repository size.
</span></span><span style=display:flex><span>To watch the log and process run: tail -f $CATALINA_HOME/logs/fedora-rebuild.out
</span></span><span style=display:flex><span>Truncating old SQL tables.
</span></span><span style=display:flex><span>mysql: <span style=color:#f92672>[</span>Warning<span style=color:#f92672>]</span> Using a password on the command line interface can be insecure.
</span></span><span style=display:flex><span>Automatically tailing the log file...
</span></span><span style=display:flex><span>Press CTRL+C to stop watching at any time. This will NOT stop the rebuild process
</span></span></code></pre></div><ul><li>After a good period of time, again depending on the size of your Fedora collection there should be output like the example below. This indicates that the Fedora RI & SQL reindex process was successful. The number of objects rebuilt will vary. You can hit the CNTRL and C keys to exit out of the process, if need be. Do not exit the Fedora container yet, one more index to go; Solr.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Adding object <span style=color:#75715e>#31: islandora:sp_web_archive_collection</span>
</span></span><span style=display:flex><span>Adding object <span style=color:#75715e>#32: islandora:sp_web_archive</span>
</span></span><span style=display:flex><span>Adding object <span style=color:#75715e>#33: islandora:newspaperPageCModel</span>
</span></span><span style=display:flex><span>Adding object <span style=color:#75715e>#34: islandora:compound_collection</span>
</span></span><span style=display:flex><span>Adding object <span style=color:#75715e>#35: islandora:newspaperCModel</span>
</span></span><span style=display:flex><span>Adding object <span style=color:#75715e>#36: islandora:newspaperIssueCModel</span>
</span></span><span style=display:flex><span>Adding object <span style=color:#75715e>#37: ir:citationCollection</span>
</span></span><span style=display:flex><span>Adding object <span style=color:#75715e>#38: islandora:sp_basic_image_collection</span>
</span></span><span style=display:flex><span>SUCCESS: <span style=color:#ae81ff>38</span> objects rebuilt.
</span></span><span style=display:flex><span>OK - Started application at context path <span style=color:#f92672>[</span>/fedora<span style=color:#f92672>]</span>
</span></span></code></pre></div><div class=annotation><p>My process here was:</p><pre tabindex=0><code>[islandora@dgdocker1 dg-isle]$ docker exec -w /utility_scripts isle-fedora-dg ./rebuildFedora.sh
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   202    0   202    0     0   1819      0 --:--:-- --:--:-- --:--:--  1819
Stopping FEDORA.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    51    0    51    0     0     18      0 --:--:--  0:00:02 --:--:--    18
OK - Stopped application at context path [/fedora]
Starting the rebuild process in the background. This may take a while depending on your Fedora repository size.
...
</code></pre></div><h3 id=reindex-solr-33>Reindex Solr (3/3)</h3><p><strong>WARNING</strong> - This reindex process takes the longest of all three, with up to <strong>1-30 or more hours</strong> to complete depending on the size of your Fedora collection. As such, it is recommended starting a screen session prior to running the following command. Learn more about <a href=https://www.tecmint.com/screen-command-examples-to-manage-linux-terminals/>screen here</a></p><ul><li>Still staying within the <code>utility_scripts</code> directory on the Fedora container or reenter the Fedora container having started a new screen session, now run the <code>updateSolrIndex.sh</code> script. This script will give you output like the example below.<ul><li><code>./updateSolrIndex.sh</code></li></ul></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>FedoraGenericSearch <span style=color:#f92672>(</span>FGS<span style=color:#f92672>)</span> update Solr index from Fedora helper script.
</span></span><span style=display:flex><span>Starting to reindex your Fedora repository. This process runs in the background and may take some time.
</span></span><span style=display:flex><span>Checked and this operation is still running. You may disconnect and the process will <span style=color:#66d9ef>continue</span> to run.
</span></span><span style=display:flex><span>Find logs at /usr/local/tomcat/logs/fgs-update-foxml.out and /usr/local/tomcat/logs/fgs-update-foxml.err.
</span></span><span style=display:flex><span>You can watch log file <span style=color:#e6db74>&#39;tail -f /usr/local/tomcat/logs/fedoragsearch.daily.log&#39;</span> as the process runs.
</span></span></code></pre></div><p><strong>Note:</strong> Within this output, options to tail logs and watch progress are offered. Depending on the size of your collection this process may take hours, however it is okay to exit out of the container and even log off the remote Production server. You can check back frequently by running <code>tail -f /usr/local/tomcat/logs/fgs-update-foxml.out</code> on the Fedora container. If you visit your Drupal site and run a Solr search, you should start to see objects and facets start to work. The number of objects will increase over time.</p><ul><li>After a good period of time, again depending on the size of your Fedora collection, when the Solr re-index process finishes, output like the example below will appear in the <code>/usr/local/tomcat/logs/fgs-update-foxml.out</code> log. This indicates that the Solr reindex process was completed. The number of objects rebuilt will vary. You can hit the CNTRL and C keys to exit out of the tail process, if need be.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> tail -f /usr/local/tomcat/logs/fgs-update-foxml.out
</span></span><span style=display:flex><span>Args
</span></span><span style=display:flex><span>0<span style=color:#f92672>=</span>http://localhost:8080
</span></span><span style=display:flex><span>1<span style=color:#f92672>=</span>updateIndex
</span></span><span style=display:flex><span>2<span style=color:#f92672>=</span>fromFoxmlFiles
</span></span><span style=display:flex><span>&lt;?xml version<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1.0&#34;</span> encoding<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>?&gt;
</span></span><span style=display:flex><span>&lt;resultPage operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;updateIndex&#34;</span> action<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;fromFoxmlFiles&#34;</span> value<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span> repositoryName<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;FgsRepos&#34;</span> indexNames<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span> resultPageXslt<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span> dateTime<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Thu Aug 08 20:43:12 GMT 2019&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;updateIndex xmlns:dc<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://purl.org/dc/elements/1.1/&#34;</span> xmlns:foxml<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;info:fedora/fedora-system:def/foxml#&#34;</span> xmlns:zs<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://www.loc.gov/zing/srw/&#34;</span> warnCount<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span> docCount<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;13&#34;</span> deleteTotal<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span> updateTotal<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;13&#34;</span> insertTotal<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span> indexName<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;FgsIndex&#34;</span>/&gt;
</span></span><span style=display:flex><span>&lt;/resultPage&gt;
</span></span></code></pre></div><ul><li>Type <code>exit</code> when finished to exit the container.</li></ul><div class=annotation><p>Like the previous step, my process here was:</p><pre tabindex=0><code>[islandora@dgdocker1 dg-isle]$ docker exec -w /utility_scripts isle-fedora-dg ./updateSolrIndex.sh
</code></pre><p>Followed by a few hours of testing and waiting.</p></div><hr><h2 id=step-18-on-remote-production---review-and-test-the-drupal-production-site>Step 18: On Remote Production - Review and Test the Drupal Production Site</h2><ul><li><p>In your web browser, enter this URL: <code>https://yourprojectnamehere.institution.edu</code></p><ul><li>Please note: You should not see any errors with respect to the SSL certifications. If so, please review your previous steps especially if using Let&rsquo;s Encrypt. You may need to repeat those steps to get rid of the errors.</li></ul></li><li><p>Log in to the local Islandora site with the credentials (&ldquo;DRUPAL_ADMIN_USER&rdquo; and &ldquo;DRUPAL_ADMIN_PASS&rdquo;) you created in &ldquo;production.env&rdquo;.</p><ul><li><strong>Note:</strong> You are free to use previously Drupal admin or user accounts created during the Local site development process.</li></ul></li><li><p>You can decide to further QC and review the site as you wish or start to add digital collections and objects.</p><ul><li>You could also further test using the <a href=https://github.com/Islandora-Collaboration-Group/islandora-sample-objects>Islandora Sample Objects</a> as you may have done in the previous Local installation.</li></ul></li></ul><div class=annotation><p><strong>Eureka! It works.</strong> The site is up and running, with no apparent issues, at <a href=https://digital.grinnell.edu>https://digital.grinnell.edu</a>.</p></div><hr><h2 id=next-steps>Next Steps</h2><div class=annotation><p>Here again, I found these &ldquo;Next Steps&rdquo; to be <strong>UNECESSARY</strong>.</p></div><p>Once you are ready to deploy your finished Drupal site, you may progress to launching the Production site publicly which could involve the following steps depending on choices made earlier in this document and process:</p><ul><li><p>If you followed the use of the temporary <code>-newprod</code> suggestion in the <code>Assumptions</code> section, remove the <code>-newprod</code> from all domain references and configuration files and recommit the change on the remote server in git.</p><ul><li>If using commercial SSLs, you&rsquo;ll also need to copy them over to the <code>./config/proxy/ssl-certs</code> directory and adjust the <code>traefik.production.toml</code> file accordingly with the new file names.</li><li>If using Let&rsquo;s Encrypt, upon restart with the new settings, the acme.json file contents will change automatically.</li><li>Update the DNS records to repoint the current non-ISLE Production server A record for <code>yourprojectnamehere.institution.edu</code> to the new ISLE host server IP.</li><li>Remove the temporary DNS A record for <code>yourprojectnamehere-newprod.institution.edu</code></li></ul></li><li><p>Lift any firewall restrictions and allowing full Internet access on http (port 80) and https (443).</p><ul><li>Do not allow any other port to be publicly accessible.</li></ul></li></ul><hr><h2 id=additional-resources>Additional Resources</h2><ul><li><a href=../install/install-environments.md>ISLE Installation: Environments</a> help with explaining the ISLE structure, the associated files, and what values ISLE end-users should use for the &ldquo;.env&rdquo;, &ldquo;local.env&rdquo;, etc.</li><li><a href=../install/install-local-resources.md>Local ISLE Installation: Resources</a> contains Docker container passwords and URLs for administrator testing.</li><li><a href=../install/install-troubleshooting.md>ISLE Installation: Troubleshooting</a> contains help for port conflicts, non-running Docker containers, etc.</li></ul><hr><h3 id=end-of-production-isle-installation-new-site>End of Production ISLE Installation: New Site</h3><p>And that&rsquo;s a wrap. Until next time&mldr;</p></div><div class=post-footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//digital-library-applications-developer-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></main></body></html>