<!doctype html><html lang=en-us><head><title>Fixing the VAF Cert Problem // The Grinnell College Digital Library Application Developer's Blog</title><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Mark A. McFate"><meta name=description content><link rel=stylesheet href=https://static.grinnell.edu/dlad-blog/css/main.min.bc1abb622a656fb4c816fed09d36c15e272b31b7beae2e7113b2f9418bff0361.css><script type=text/javascript src=https://static.grinnell.edu/dlad-blog/js/pdf-js/build/pdf.js></script><meta name=twitter:card content="summary"><meta name=twitter:title content="Fixing the VAF Cert Problem"><meta name=twitter:description content="True to form, just after posting my lengthy description of VAF cert problems I figured out what was wrong and how to fix it. Naturally, just after.
So, the root of my VAF woes stemmed from the fact that Let&rsquo;s Encrypt, upon my request, had previously issued an untrusted cert for https://vaf.grinnell.edu (because I used the staging environment during development of this blog), and I was unable to find it or override it with a trusted cert. I was under the impression that in my workflow the cert was being stored inside one of my Docker containers&mldr; and it was."><meta property="og:title" content="Fixing the VAF Cert Problem"><meta property="og:description" content="True to form, just after posting my lengthy description of VAF cert problems I figured out what was wrong and how to fix it. Naturally, just after.
So, the root of my VAF woes stemmed from the fact that Let&rsquo;s Encrypt, upon my request, had previously issued an untrusted cert for https://vaf.grinnell.edu (because I used the staging environment during development of this blog), and I was unable to find it or override it with a trusted cert. I was under the impression that in my workflow the cert was being stored inside one of my Docker containers&mldr; and it was."><meta property="og:type" content="article"><meta property="og:url" content="https://static.grinnell.edu/dlad-blog/posts/016-fixing-vaf-cert-problems/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-29T00:00:00+00:00"><meta property="article:modified_time" content="2019-05-29T00:00:00+00:00"></head><body><header class=app-header><a href=https://static.grinnell.edu/dlad-blog/><img class=app-header-avatar src=https://static.grinnell.edu/dlad-blog/avatar.jpg alt="Mark A. McFate"></a><h2>The Grinnell College Digital Library Application Developer's Blog</h2><div class=author-block><p class=site-rev>Compiled: Feb 17, 2023 at 2:33pm CST<br>Content Updated: 2023-Feb-16 13:07 CST</p><div class=name>by
<strong>Mark A. McFate</strong></div><div class=address>Grinnell College Libraries</div><div class=link><a href=mailto:></a></div><br></div><nav class=sidebar-nav><a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/search/ title>Search This Blog</a>
<a class=sidebar-nav-item href=https://static.grinnell.edu/dlad-blog/about/ title>About Me</a></nav><p class=site-description>Mark&rsquo;s first Hugo site, a blog, formerly on prem at Static.Grinnell.edu, moved to <em>DigitalOcean</em>, then to <em>Azure</em>, and now hosted on <em>GitHub Pages</em>.</p><div class=app-header-social><a target=_blank href=https://github.com/McFateM><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/gohugoio><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div><p class=copyright>The views and opinions expressed on this site belong solely to the original author(s) and do not necessarily represent or reflect those of Grinnell College.</p></header><main class=app-container><div class=breadcrumbs><a href=https://static.grinnell.edu/dlad-blog/>Home</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/>Posts</a>
&bull; <a href=https://static.grinnell.edu/dlad-blog/posts/016-fixing-vaf-cert-problems/>016 fixing vaf cert problems</a></div><article class=post><header class=post-header><h1 class=post-title>Fixing the VAF Cert Problem</h1><div class=post-meta><script>console.log("Hugo Debug: ",JSON.parse('"2019-05-30T00:00:00Z"'))</script><script>console.log("Hugo Debug: ",JSON.parse('"2019-05-29T00:00:00Z"'))</script><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
May 29, 2019
&nbsp;&nbsp;&bull;&nbsp;&nbsp;<strong><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-at-sign"><title>at-sign</title><circle cx="12" cy="12" r="4"/><path d="M16 8v5a3 3 0 006 0v-1a10 10 0 10-3.92 7.94"/></svg> Mark A. McFate</strong></div></header><div class=post-content><p>True to form, <strong>just after</strong> posting my <a href=https://static.grinnell.edu/dlad-blog/posts/015-working-with-lets-encrypt>lengthy description of VAF cert problems</a> I figured out what was wrong and how to fix it. Naturally, <strong>just after</strong>.</p><p>So, the root of my <em>VAF</em> woes stemmed from the fact that <em>Let&rsquo;s Encrypt</em>, upon my request, had previously issued an untrusted cert for <a href=https://vaf.grinnell.edu>https://vaf.grinnell.edu</a> (because I used the staging environment during development of this blog), and I was unable to find it or override it with a trusted cert. I was under the impression that in my workflow the cert was being stored inside one of my Docker containers&mldr; and it was. But I couldn&rsquo;t fathom why the untrusted cert seemed to &ldquo;persist&rdquo;, even though I had deleted and regenerated those containers many times. Hmmm&mldr;</p><p>All of this was compounded by the fact that in my configuration the <em>Traefik</em> container is built from &ldquo;scratch&rdquo; so that it is very &ldquo;lean&rdquo;. That essentially means there&rsquo;s no shell in the container, so I can&rsquo;t just do <code>docker exec -it traefik_proxy sh</code> to open a terminal and look inside.</p><p>Finally, this morning, I took a hard look at the <code>files/docker-compose.yml</code> in my <a href=https://github.com/McFateM/docker-bootstrap>docker-bootstrap</a> project and it dawned on me&mldr; that workflow explicitly saves certs into a protected <code>/root/acme.json</code> file as part of the <code>traefik_proxy</code> service configuration, like so:</p><pre tabindex=0><code>proxy:
  container_name: traefik_proxy
  image: traefik
  command: &gt;-
    --docker --logLevel=INFO \
    ...
    --acme.storage=&#34;/root/acme.json&#34; \
    ...
</code></pre><p>That&rsquo;s common enough. <strong>But why would that data persist even when I rebuild <code>traefik_proxy</code>?</strong></p><p>What I didn&rsquo;t realize, until this morning, was that elsewhere in <code>files/docker-compose.yml</code> there&rsquo;s this:</p><pre tabindex=0><code>proxy:
  ...
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - /dev/null:/traefik.toml
    - /root/acme.json:/root/acme.json   
</code></pre><p>That last line is the <strong>key</strong>! It&rsquo;s telling the configuration that <code>/root/acme.json</code> <strong>should persist on the SERVER</strong> and map to <code>/root/acme.json</code> inside the <code>traefik_proxy</code> container. Duh, that&rsquo;s where the certs live&mldr;and <strong>persist</strong>.</p><p>The steps I took to fix this, from a terminal on <code>static.grinnell.edu</code>, were:</p><pre tabindex=0><code>root@static:~# cp -f acme.json acme.json.bak
root@static:~# rm -f acme.json
root@static:~# touch acme.json
root@static:~# chmod 500 acme.json
root@static:~# docker stop $(docker ps -q); docker rm -v $(docker ps -qa); docker system prune
</code></pre><p>The first four lines above made a backup of <code>acme.json</code>, just in case, then removed and replaced it with a pristine, empty file with proper permissions. The last line stopped all of the Docker containers running on the server, removed them and their associated volumes, then pruned away all remnants (images, networks, etc.) of those containers.</p><p>After this I started rebuilding the server and services using the process documented in <a href=https://static.grinnell.edu/dlad-blog/posts/008-docker-bootstrap-workflow>docker-bootstrap Workflow</a>. Problem solved! Woot! Along the way I watched the process create fresh, new, <strong>trusted</strong> certs in the server&rsquo;s new <code>/root/acme.json</code> file.</p><p>And that&rsquo;s a wrap. Until next time&mldr;</p></div><div class=post-footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//digital-library-applications-developer-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></main></body></html>